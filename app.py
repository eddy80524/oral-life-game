"""
„ÅäÂè£„ÅÆ‰∫∫Áîü„Ç≤„Éº„É† - Âçò‰∏Ä„Éö„Éº„Ç∏„Ç¢„Éó„É™
"""
import streamlit as st
import streamlit.components.v1 as components
import sys
import os
import json
import random
import time
from datetime import datetime

# services„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Éë„Çπ„Å´ËøΩÂä†
sys.path.append(os.path.join(os.path.dirname(__file__), 'services'))

from services import teeth as teeth_service  # noqa: E402
from services.video_helper import display_video, ensure_video_directories  # noqa: E402

ensure_video_directories()

# „Éö„Éº„Ç∏Ë®≠ÂÆö
st.set_page_config(
    page_title="„ÅäÂè£„ÅÆ‰∫∫Áîü„Ç≤„Éº„É†",
    page_icon="ü¶∑",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# „Ç´„Çπ„Çø„É†CSSÔºà„Çπ„Éû„ÉõÊúÄÈÅ©ÂåñÔºâ
st.markdown("""
<style>
    /* „Ç¢„Éó„É™ÂÖ®‰Ωì„ÅÆËÉåÊôØËâ≤Ë®≠ÂÆö */
    .main {
        background-color: #EFE4D0;
    }
    
    /* Streamlit„ÅÆ„Éá„Éï„Ç©„É´„ÉàCSS„ÇØ„É©„Çπ„Å´„Çà„ÇãËÉåÊôØËâ≤Ë®≠ÂÆö */
    .stApp {
        background-color: #EFE4D0;
    }
    
    /* „Ç≥„É≥„ÉÜ„Éä„ÅÆËÉåÊôØ„ÇÇÂêåËâ≤„Å´ */
    .main .block-container {
        background-color: #EFE4D0;
        padding-top: 1rem;
        padding-bottom: 1rem;
        max-width: 100%;
    }
    
    /* „Çµ„Ç§„Éâ„Éê„Éº„ÇíÂÆåÂÖ®„Å´Èö†„Åô */
    .css-1d391kg {display: none;}
    section[data-testid="stSidebar"] {display: none;}
    .css-1lcbmhc {display: none;}
    
    /* Â§ß„Åç„Å™„Éú„Çø„É≥ */
    .stButton > button {
        width: 100%;
        height: 3.5rem;
        font-size: 1.3rem;
        font-weight: bold;
        margin: 0.5rem 0;
        border-radius: 10px;
    }
    
    /* „Éò„ÉÉ„ÉÄ„Éº„Éê„ÉÉ„Ç∏ */
    .status-badge {
        background-color: #FEFCF7;
        border: 2px solid #4CAF50;
        border-radius: 10px;
        padding: 15px;
        margin: 10px;
        text-align: center;
        font-weight: bold;
    }
    
    .teeth-count {
        background-color: #FFF5E6;
        color: #d2691e;
    }
    
    .tooth-coins {
        background-color: #F0FFF0;
        color: #228b22;
    }
    
    /* „Ç´„Éº„ÉâÈ¢®„Éá„Ç∂„Ç§„É≥ */
    .game-card {
        background-color: #FEFCF7;
        border: 2px solid #E8DCC0;
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* „Çà„ÇäÁ¢∫ÂÆü„Å™ËÉåÊôØËâ≤ÈÅ©Áî® */
    html, body, [data-testid="stApp"] {
        background-color: #EFE4D0 !important;
    }
    
    /* ÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„ÉäËÉåÊôØ */
    .stApp > div:first-child {
        background-color: #EFE4D0 !important;
    }
    
    /* „É°„Ç§„É≥„Ç®„É™„Ç¢„ÅÆËÉåÊôØ */
    section.main > div {
        background-color: #EFE4D0 !important;
    }
    
    /* ÈÄ≤Ë°å„Éê„Éº */
    .progress-container {
        background-color: #e0e0e0;
        border-radius: 15px;
        height: 35px;
        margin: 15px 0;
        overflow: hidden;
        border: 2px solid #ddd;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #4CAF50, #45a049);
        height: 100%;
        transition: width: 0.8s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        min-width: 120px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* „É¢„Éê„Ç§„É´ÂØæÂøú */
    @media (max-width: 768px) {
        .progress-container {
            height: 40px;
            margin: 10px 0;
        }
        
        .progress-fill {
            font-size: 0.8rem;
            min-width: 100px;
        }
    }
    
    /* „Çø„Ç§„Éà„É´ */
    .main-title {
        text-align: center;
        color: #4CAF50;
        margin-bottom: 20px;
    }
    
    /* „Ç∑„É≥„Éó„É´„Å™Ê≠Ø„ÅÆË°®Á§∫ */
    .simple-teeth-container {
        background: linear-gradient(135deg, #FFF8EC, #FFEBD4);
        border: 3px solid #D6C5A5;
        border-radius: 24px;
        padding: 18px 20px 16px;
        margin: 12px 0;
        box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        position: relative;
    }
    .simple-teeth-container::after {
        content: "";
        position: absolute;
        top: 16px;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        width: 3px;
        background: linear-gradient(180deg, transparent 0%, #bca88e 15%, #8f775e 50%, #bca88e 85%, transparent 100%);
        border-radius: 999px;
        opacity: 0.9;
    }
    .simple-teeth-row {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin: 8px 0;
    }
    .simple-tooth-block,
    .simple-tooth-block-labeled {
        width: 38px;
        height: 44px;
        border-radius: 12px;
        border: 2px solid #d9cfc1;
        background: #f6f1e8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: #6b5135;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        position: relative;
    }
    .simple-tooth-block.is-filled,
    .simple-tooth-block-labeled.is-filled {
        background: linear-gradient(180deg, #ffffff, #f3ede2);
    }
    .simple-tooth-block.is-missing,
    .simple-tooth-block-labeled.is-missing {
        background: linear-gradient(180deg, #fde7e7, #f8d8d8);
        border-style: dashed;
        color: #a56464;
        opacity: 0.75;
    }
    .simple-tooth-block-labeled::after {
        content: attr(data-label);
        position: absolute;
        bottom: -1.6rem;
        left: 50%;
        transform: translate(-50%, 4px);
        background: rgba(123, 85, 46, 0.92);
        color: #fff;
        font-size: 0.68rem;
        padding: 3px 7px;
        border-radius: 10px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease, transform 0.15s ease;
        box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .simple-tooth-block-labeled:hover::after {
        opacity: 1;
        transform: translate(-50%, 0);
    }
    .teeth-midline {
        height: 2px;
        width: 86%;
        margin: 0 auto;
        background: linear-gradient(90deg, transparent 0%, #bca88e 10%, #8f775e 50%, #bca88e 90%, transparent 100%);
        border-radius: 999px;
    }
    .simple-teeth-label {
        text-align: center;
        font-weight: bold;
        color: #7a4e27;
        margin-top: 6px;
    }
    .teeth-count-label {
        text-align: center;
        font-size: 1.15em;
        font-weight: bold;
        color: #8B4513;
        margin-top: 12px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    .coin-visual-container {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        border: 3px solid #FF8C00;
        border-radius: 20px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .coin-stack {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin: 10px 0;
    }
    
    .coin {
        width: 40px;
        height: 40px;
        background: radial-gradient(circle at 30% 30%, #FFD700, #FFA500);
        border: 3px solid #B8860B;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #8B4513;
        font-size: 1.2em;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        animation: coinShine 2s infinite;
    }
    
    @keyframes coinShine {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 6px 12px rgba(255, 215, 0, 0.5); }
    }
    
    .coin-count-label {
        text-align: center;
        font-size: 1.2em;
        font-weight: bold;
        color: #8B4513;
        margin-top: 10px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    
    /* „É´„Éº„É¨„ÉÉ„Éà„Éë„Éç„É´ */
    .roulette-card {
        background: linear-gradient(135deg, #fffdf5, #fff6e6);
        border: 2px solid #f5d7a1;
        border-radius: 22px;
        padding: 1.75rem 1.5rem;
        text-align: center;
        box-shadow: 0 10px 18px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }
    
    .roulette-subtitle {
        margin: 0 0 1rem;
        font-weight: 600;
        color: #7b552e;
        letter-spacing: 0.03em;
    }
    
    .roulette-number-row {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin: 1rem 0 1.25rem;
    }
    
    .roulette-number-chip {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.65rem;
        font-weight: bold;
        color: #fff;
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }
    
    .roulette-number-chip[data-value="1"] {
        background: linear-gradient(135deg, #f94144, #f3722c);
    }
    
    .roulette-number-chip[data-value="2"] {
        background: linear-gradient(135deg, #f8961e, #f9c74f);
        color: #5c3b00;
    }
    
    .roulette-number-chip[data-value="3"] {
        background: linear-gradient(135deg, #43aa8b, #577590);
    }

    .roulette-number-chip.is-active {
        transform: scale(1.08);
        box-shadow: 0 10px 22px rgba(0,0,0,0.2);
        outline: 4px solid rgba(255, 255, 255, 0.9);
        outline-offset: -4px;
    }

    .roulette-number-chip.is-disabled {
        opacity: 1;
        filter: none;
    }

    .roulette-result-card {
        background: linear-gradient(135deg, #fffef8, #fef2d8);
        border: 2px dashed #f3c577;
        border-radius: 18px;
        padding: 1.25rem 1.5rem;
        margin-top: 1rem;
        color: #7b552e;
        font-weight: 600;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
    }
    
    .roulette-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 1.2rem;
    }
    
    .roulette-actions .stButton button {
        min-width: 180px;
    }
    
    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÊºîÂá∫ */
    .loading-dots {
        display: inline-flex;
        gap: 0.35rem;
        align-items: center;
        justify-content: center;
    }
    .loading-dots span {
        width: 0.55rem;
        height: 0.55rem;
        border-radius: 50%;
        background: #f59e0b;
        opacity: 0.2;
        animation: dotPulse 1.2s infinite ease-in-out;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
        0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
        40% { opacity: 1; transform: scale(1.1); }
    }
    
    /* „Éú„Éº„ÉâÈÄ≤Ë°å„Éà„É©„ÉÉ„Ç´„Éº */
    .board-progress-track {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.35rem;
        margin: 0.75rem 0 1.5rem;
    }
    .board-progress-node {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #dacab2;
        color: #715739;
        font-size: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
    }
    .board-progress-node.is-visited {
        background: linear-gradient(135deg, #b5d17a, #9ac755);
        color: #fff;
        opacity: 0.9;
    }
    .board-progress-node.is-current {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: #fff;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.25);
        transform: scale(1.05);
    }
    
    @media (max-width: 768px) {
        .tooth {
            width: 24px;
            height: 30px;
        }
        .coin {
            width: 35px;
            height: 35px;
            font-size: 1em;
        }
    }
</style>
""", unsafe_allow_html=True)

# „Éö„Éº„Ç∏ÁÆ°ÁêÜÁî®„ÅÆÁä∂ÊÖãÂàùÊúüÂåñ
if 'current_page' not in st.session_state:
    st.session_state.current_page = 'reception'

# „Éö„Éº„Ç∏ÈÄ≤Ë°åÁä∂Ê≥Å„ÅÆÂÆöÁæ©
PAGE_FLOW = {
    'reception': {'title': 'üìã Âèó‰ªò„Éª„Éó„É≠„É≠„Éº„Ç∞', 'next': 'game_board'},
    'game_board': {'title': 'üé≤ „Ç≤„Éº„É†„Éú„Éº„Éâ', 'next': 'caries_quiz'},
    'caries_quiz': {'title': 'ü¶∑ „ÇÄ„ÅóÊ≠Ø„ÇØ„Ç§„Ç∫', 'next': 'game_board'},
    'job_experience': {'title': 'üë©‚Äç‚öïÔ∏è ËÅ∑Ê•≠‰ΩìÈ®ì', 'next': 'checkup'},
    'checkup': {'title': 'üè• ÂÆöÊúüÂÅ•Ë®∫', 'next': 'game_board'},
    'perio_quiz': {'title': 'ü¶∑ Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫', 'next': 'goal'},
    'goal': {'title': 'üèÅ „Ç¥„Éº„É´„Éª„É©„É≥„Ç≠„É≥„Ç∞', 'next': 'line_coloring'},
    'line_coloring': {'title': 'üì± LINE', 'next': 'reception'},
    'staff_management': {'title': '‚öôÔ∏è „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ', 'next': 'reception'}
}


def staff_access_enabled() -> bool:
    """Query parameter based toggle for exposing staff tools."""
    try:
        params = st.query_params  # Streamlit 1.31+
    except Exception:
        params = {}

    raw_value = params.get('staff', '0') if params else '0'
    if isinstance(raw_value, list):
        raw_value = raw_value[0] if raw_value else '0'

    flag = str(raw_value).lower() in {'1', 'true', 'yes', 'on'}
    st.session_state.staff_mode_allowed = flag
    return st.session_state.staff_mode_allowed



def show_coin_change(old_coins, new_coins, reason=""):
    """„Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥„ÅÆÂ¢óÊ∏õ„ÇíË¶ñË¶öÁöÑ„Å´Ë°®Á§∫"""
    change = new_coins - old_coins
    
    if change > 0:
        # „Ç≥„Ç§„É≥Â¢óÂä†
        st.markdown(f"""
        <div style='text-align: center; background: linear-gradient(135deg, #FFD700, #FFA500); 
                    padding: 20px; border-radius: 15px; border: 3px solid #FF8C00; 
                    margin: 20px 0; box-shadow: 0 6px 12px rgba(0,0,0,0.2);'>
            <h2 style='color: #B8860B; margin: 5px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);'>
                ü™ô „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥ „Ç≤„ÉÉ„ÉàÔºÅ ü™ô
            </h2>
            <div style='font-size: 2.5em; margin: 10px 0;'>
                <span style='color: #8B4513; font-weight: bold;'>{old_coins}</span>
                <span style='color: #228B22; font-size: 1.2em; margin: 0 10px;'>+{change}</span>
                <span style='color: #8B4513; font-weight: bold;'>‚Üí {new_coins}</span>
            </div>
            <p style='color: #8B4513; font-size: 1.2em; margin: 5px 0; font-weight: bold;'>
                {reason}
            </p>
        </div>
        """, unsafe_allow_html=True)
        st.balloons()
    elif change < 0:
        # „Ç≥„Ç§„É≥Ê∏õÂ∞ë
        st.markdown(f"""
        <div style='text-align: center; background: linear-gradient(135deg, #FFB6C1, #FFA0B4); 
                    padding: 20px; border-radius: 15px; border: 3px solid #DC143C; 
                    margin: 20px 0; box-shadow: 0 6px 12px rgba(0,0,0,0.2);'>
            <h2 style='color: #8B0000; margin: 5px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);'>
                üí∏ „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥ „Å∏„Å£„Å°„ÇÉ„Å£„Åü... üí∏
            </h2>
            <div style='font-size: 2.5em; margin: 10px 0;'>
                <span style='color: #8B4513; font-weight: bold;'>{old_coins}</span>
                <span style='color: #DC143C; font-size: 1.2em; margin: 0 10px;'>{change}</span>
                <span style='color: #8B4513; font-weight: bold;'>‚Üí {new_coins}</span>
            </div>
            <p style='color: #8B0000; font-size: 1.2em; margin: 5px 0; font-weight: bold;'>
                {reason}
            </p>
        </div>
        """, unsafe_allow_html=True)
    else:
        # Â§âÂåñ„Å™„Åó
        st.info(f"ü™ô „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥: {new_coins}„Åæ„ÅÑ (Â§âÂåñ„Å™„Åó)")


def apply_tooth_effects(game_state, landing_cell, feedback):
    """„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„Å´Âøú„Åò„ÅüÊ≠Ø„ÅÆÁä∂ÊÖãÂ§âÂåñ„ÇíÈÅ©Áî®"""
    teeth_service.ensure_tooth_state(game_state)
    tooth_messages = feedback.setdefault('tooth_messages', [])
    title = landing_cell.get('title', '')
    action = landing_cell.get('action')
    effect_applied = False

    if title == "Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫":
        if teeth_service.upgrade_to_adult(game_state):
            teeth_service.sync_teeth_count(game_state)
            game_state['teeth_count'] = 28
            game_state['teeth_max'] = 28
            st.session_state.teeth_count = 28
            tooth_messages.append(('success', '‚ú® Â§ß‰∫∫„ÅÆÊ≠Ø„Åå „Åú„Çì„Å∂Áîü„Åà„Åù„Çç„Å£„Åü„ÇàÔºÅ28Êú¨„Å´„Å™„Å£„Åü„Å≠„ÄÇ'))
            effect_applied = True
    if title == "Âàù„ÇÅ„Å¶‰π≥Ê≠Ø„ÅåÊäú„Åë„Åü":
        lost = teeth_service.lose_primary_tooth(game_state, count=1)
        if lost:
            tooth_messages.append(('info', 'üë∂ ‰π≥Ê≠Ø„Åå1Êú¨„Å¨„Åë„Åü„Çà„ÄÇÂ§ß‰∫∫„ÅÆÊ≠Ø„Åå„ÅØ„Åà„Å¶„Åè„Çã„Åæ„Åß„Åæ„Å£„Å¶„ÅÑ„Çà„ÅÜÔºÅ'))
            effect_applied = True
    if title == "Ëô´Ê≠Ø„Åå„Åß„Åç„Åü":
        damaged = teeth_service.damage_random_tooth(
            game_state,
            kinds=(
                "first_premolar",
                "second_premolar",
                "first_molar",
                "second_molar",
                "primary_first_molar",
                "primary_second_molar",
            ),
        )
        if damaged:
            tooth_messages.append(('warning', '‚ö†Ô∏è Ëô´Ê≠Ø„Åå„Åß„Åç„Å°„ÇÉ„Å£„Åü‚Ä¶ÂÆöÊúüÊ§úË®∫„Åß„Å™„Åä„Åù„ÅÜÔºÅ'))
            effect_applied = True
    if title == "„Ç∏„É•„Éº„Çπ„Çí„Åä„Å≠„Å†„Çä":
        stained = teeth_service.stain_teeth(game_state, count=3)
        if stained:
            tooth_messages.append(('warning', 'ü•§ „Ç∏„É•„Éº„Çπ„Å∞„Åã„Çä„ÅßÊ≠Ø„Åå„Åô„Åì„ÅóÈªÑ„Å∞„Çì„Åß„Åç„Åü„Çà„ÄÇ'))
            effect_applied = True
    if title == "„Éê„Ç§„ÇØ„ÅßÂ§ß‰∫ãÊïÖ":
        lost = teeth_service.lose_specific_teeth(game_state, ["UL1", "UR1"], permanent=True)
        if lost:
            tooth_messages.append(('error', 'üí• „Åæ„ÅàÊ≠Ø„Åå2Êú¨„Åä„Çå„Å¶„Åó„Åæ„Å£„Åü‚Ä¶„Åç„Çí„Å§„Åë„Çà„ÅÜÔºÅ'))
            effect_applied = True
    if title == "Ëå∂Ê∏ãÈô§Âéª":
        cleaned = teeth_service.whiten_teeth(game_state)
        if cleaned:
            tooth_messages.append(('success', '‚ú® Ëå∂Ê∏ã„Çí„Åç„Çå„ÅÑ„Å´„Åó„Å¶Ê≠Ø„Åå„Éî„Ç´„Éî„Ç´„Å´„Å™„Å£„Åü„ÇàÔºÅ'))
            effect_applied = True
    if title == "ÂÖ•„ÇåÊ≠Ø‰ΩúÊàê":
        added = teeth_service.add_prosthetics(game_state, count=2)
        if added:
            tooth_messages.append(('info', 'ü¶∑ ÂÖ•„ÇåÊ≠Ø„Åß„Å™„Åè„Å™„Å£„ÅüÊ≠Ø„Åå„ÇÇ„Å©„Å£„Åü„Çà„ÄÇ'))
            effect_applied = True
    if landing_cell.get('type') == 'stop':
        repaired = teeth_service.repair_damaged_teeth(game_state)
        cleaned = teeth_service.whiten_teeth(game_state)
        if repaired or cleaned:
            tooth_messages.append(('success', 'ü™• ÂÆöÊúüÊ§úË®∫„ÅßÊ≠Ø„Åå„Åç„Çå„ÅÑ„Å´„Å™„Å£„Åü„ÇàÔºÅ'))
            effect_applied = True
    if action == 'floss_check':
        repaired = teeth_service.repair_damaged_teeth(game_state)
        if repaired:
            tooth_messages.append(('success', 'üßµ „Éï„É≠„Çπ„ÅßÊ≠Ø„ÅåÂÖÉÊ∞ó„Å´„Å™„Å£„Åü„ÇàÔºÅ'))
            effect_applied = True
    if action == 'smile_together':
        cleaned = teeth_service.whiten_teeth(game_state)
        if cleaned:
            tooth_messages.append(('success', 'üòÅ „Åç„Çå„ÅÑ„Å™Ê≠ØËåé„Åß„Å´„Å£„Åì„ÇäÁ¨ëÈ°îÔºÅ'))
            effect_applied = True
    if action == 'dice_tooth_loss':
        from services.game_logic import lose_teeth_and_pay  # ÈÅÖÂª∂„Ç§„É≥„Éù„Éº„Éà„ÅßÂæ™Áí∞ÂØæÁ≠ñ
        outcome = lose_teeth_and_pay()
        payment = outcome.get('payment', 0)
        if payment:
            feedback['coin_messages'].append(('warning', f"üí∏ Ê≤ªÁôÇË≤ª„Å®„Åó„Å¶ {payment} „Éà„Ç•„Éº„Çπ„Åó„ÅØ„Çâ„Å£„Åü„Çà„ÄÇ"))
        lost_ids = outcome.get('lost_tooth_ids', [])
        dice_roll = outcome.get('dice_roll', 0)
        teeth_lost = outcome.get('teeth_lost', 0)
        tooth_messages.append(('warning', f"üé≤ „Çµ„Ç§„Ç≥„É≠„ÅØ {dice_roll}ÔºÅ „ÅØ„Çí {teeth_lost}Êú¨ „ÅÜ„Åó„Å™„Å£„Å¶„Åó„Åæ„Å£„Åü„Çà„ÄÇ"))
        if lost_ids:
            tooth_messages.append(('error', f"üò¢ Ê≠Ø„Çí{len(lost_ids)}Êú¨ „Å™„Åè„Åó„Å¶„Åó„Åæ„Å£„Åü‚Ä¶"))
        feedback['landing_message'] = "ü¶∑ Ê≠Ø„Çí„Åü„ÅÑ„Åõ„Å§„Å´„Åó„Çà„ÅÜÔºÅ"
        feedback['landing_tone'] = 'warning'
        feedback['next_page'] = 'refresh'
        feedback['next_button_label'] = "„Éú„Éº„Éâ„Å´„ÇÇ„Å©„Çã"
        effect_applied = True

    teeth_service.sync_teeth_count(game_state)
    st.session_state.teeth_count = game_state.get('teeth_count', st.session_state.get('teeth_count', 0))
    return effect_applied

def navigate_to(page_name):
    """„Éö„Éº„Ç∏ÈÅ∑Áßª"""
    st.session_state.current_page = page_name
    st.rerun()

def show_progress_bar():
    """„Ç≤„Éº„É†ÈÄ≤Ë°åÁä∂Ê≥Å„ÇíË°®Á§∫"""
    if st.session_state.current_page == 'reception' or st.session_state.current_page == 'staff_management':
        return
    
    # ÈÄ≤Ë°åÊÆµÈöé„ÅÆÂÆöÁæ©
    progress_stages = ['reception', 'game_board', 'caries_quiz', 'job_experience', 'checkup', 'perio_quiz', 'goal', 'line_coloring']
    current_stage_index = 0
    
    # ÁèæÂú®„ÅÆÊÆµÈöé„ÇíÁâπÂÆö
    if st.session_state.current_page in progress_stages:
        current_stage_index = progress_stages.index(st.session_state.current_page)
    
    progress_percentage = (current_stage_index / (len(progress_stages) - 1)) * 100
    
    # Â≠ê‰æõÂêë„Åë„ÅÆÈÄ≤Êçó„É°„ÉÉ„Çª„Éº„Ç∏
    if progress_percentage <= 10:
        progress_message = "üå± „Çπ„Çø„Éº„Éà"
    elif progress_percentage <= 25:
        progress_message = "üöÄ „ÅÑ„ÅÑ„Å≠ÔºÅ"
    elif progress_percentage <= 50:
        progress_message = "‚≠ê „ÅØ„Çì„Å∂„Çì"
    elif progress_percentage <= 75:
        progress_message = "üéâ „Åå„Çì„Å∞„Çå"
    elif progress_percentage <= 90:
        progress_message = "üèÜ „ÅÇ„Å®„Åô„Åì„Åó"
    else:
        progress_message = "üéä „Ç¥„Éº„É´ÔºÅ"
    
    st.markdown(f"""
    <div class="progress-container">
        <div class="progress-fill" style="width: {max(progress_percentage, 15)}%;">
            <span>{progress_message}</span>
        </div>
    </div>
    """, unsafe_allow_html=True)

def show_status_header():
    """„Ç≤„Éº„É†Áä∂ÊÖã„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºË°®Á§∫Ôºà„Éì„Ç∏„É•„Ç¢„É´ÁâàÔºâ"""
    if 'game_state' in st.session_state and st.session_state.current_page not in ['reception', 'staff_management', 'checkup', 'perio_quiz', 'caries_quiz']:
        if st.session_state.current_page == 'game_board':
            stage = st.session_state.get('game_board_stage', 'board')
            if stage == 'roulette':
                return
            if stage == 'card':
                current_position = st.session_state.game_state.get('current_position', 0)
                if current_position == 0:
                    return

        game_state = st.session_state.game_state

        col_teeth, col_coin = st.columns([0.6, 0.4])

        with col_teeth:
            current_position = game_state.get('current_position', 0)
            tooth_stage = game_state.get('tooth_stage')
            if tooth_stage in {'child', 'adult'}:
                stage = tooth_stage
            else:
                stage = 'child' if current_position < 6 else 'adult'

            if stage == 'child':
                base_order = ["‰π≥‰∏≠ÂàáÊ≠Ø", "‰π≥ÂÅ¥ÂàáÊ≠Ø", "‰π≥Áä¨Ê≠Ø", "Á¨¨‰∏Ä‰π≥ËáºÊ≠Ø", "Á¨¨‰∫å‰π≥ËáºÊ≠Ø"]
                short_map = {
                    "‰π≥‰∏≠ÂàáÊ≠Ø": "‰π≥‰∏≠",
                    "‰π≥ÂÅ¥ÂàáÊ≠Ø": "‰π≥ÂÅ¥",
                    "‰π≥Áä¨Ê≠Ø": "‰π≥Áä¨",
                    "Á¨¨‰∏Ä‰π≥ËáºÊ≠Ø": "‰π≥Ëáº1",
                    "Á¨¨‰∫å‰π≥ËáºÊ≠Ø": "‰π≥Ëáº2",
                }
                total_teeth = 20
            else:
                base_order = ["‰∏≠ÂàáÊ≠Ø", "ÂÅ¥ÂàáÊ≠Ø", "Áä¨Ê≠Ø", "Á¨¨‰∏ÄÂ∞èËáºÊ≠Ø", "Á¨¨‰∫åÂ∞èËáºÊ≠Ø", "Á¨¨‰∏ÄÂ§ßËáºÊ≠Ø", "Á¨¨‰∫åÂ§ßËáºÊ≠Ø"]
                short_map = {
                    "‰∏≠ÂàáÊ≠Ø": "‰∏≠Âàá",
                    "ÂÅ¥ÂàáÊ≠Ø": "ÂÅ¥Âàá",
                    "Áä¨Ê≠Ø": "Áä¨Ê≠Ø",
                    "Á¨¨‰∏ÄÂ∞èËáºÊ≠Ø": "Â∞èËáº1",
                    "Á¨¨‰∫åÂ∞èËáºÊ≠Ø": "Â∞èËáº2",
                    "Á¨¨‰∏ÄÂ§ßËáºÊ≠Ø": "Â§ßËáº1",
                    "Á¨¨‰∫åÂ§ßËáºÊ≠Ø": "Â§ßËáº2",
                }
                total_teeth = 28

            left_side = base_order[::-1]
            right_side = base_order
            upper_labels = left_side + right_side
            lower_labels = upper_labels
            present_teeth = min(game_state.get('teeth_count', total_teeth), total_teeth)
            if stage == 'adult' and game_state.get('teeth_missing', 0) == 0:
                present_teeth = total_teeth

            def render_row(labels, offset):
                cells = []
                for idx, label in enumerate(labels):
                    short = short_map.get(label, label)
                    filled = (offset + idx) < present_teeth
                    classes = "simple-tooth-block-labeled " + ("is-filled" if filled else "is-missing")
                    cells.append(f"<div class='{classes}' data-label='{short}'></div>")
                return ''.join(cells)

            upper_html = render_row(upper_labels, 0)
            lower_html = render_row(lower_labels, len(upper_labels))

            st.markdown(
                f"""
                <div class="simple-teeth-container">
                    <div class="simple-teeth-row teeth-upper">{upper_html}</div>
                    <div class="teeth-midline"></div>
                    <div class="simple-teeth-row teeth-lower">{lower_html}</div>
                    <div class="simple-teeth-label">ü¶∑ {present_teeth} / {total_teeth} Êú¨</div>
                </div>
                """,
                unsafe_allow_html=True,
            )

        with col_coin:
            tooth_coins = game_state.get('tooth_coins', 10)
            st.metric("üèÖ „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥", f"{tooth_coins}Êûö")

            coins_to_show = min(tooth_coins, 10)
            if coins_to_show > 0:
                icons = ["üí∞"] * coins_to_show
                while icons:
                    line = " ".join(icons[:5])
                    st.markdown(f"#### {line}")
                    icons = icons[5:]
            else:
                st.caption("„Åæ„Å†„Ç≥„Ç§„É≥„ÅØ„Å™„ÅÑ„ÇàÔºÅ")

            extra_coins = tooth_coins - coins_to_show
            if extra_coins > 0:
                st.caption(f"+ {extra_coins}Êûö")

def show_reception_page():
    """Âèó‰ªò„Éª„Éó„É≠„É≠„Éº„Ç∞„Éö„Éº„Ç∏Ôºà„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Ç¶„Ç£„Ç∂„Éº„ÉâÔºâ"""
    from services.game_logic import initialize_game_state
    from services.store import ensure_data_files, update_participant_count, get_settings
    from services.image_helper import display_image

    initialize_game_state()
    ensure_data_files()

    # „Çª„ÉÉ„Ç∑„Éß„É≥ÂàùÊúüÂåñ
    st.session_state.setdefault('participant_name', "")
    st.session_state.setdefault('participant_age', 5)
    st.session_state.setdefault('photo_consent', False)
    st.session_state.setdefault('reception_step', 0)
    st.session_state.setdefault('reception_age_label', "5„Åï„ÅÑ")

    step = st.session_state.reception_step

    # Âèó‰ªòÁîªÈù¢Áî®„ÅÆ„Çπ„Çø„Ç§„É´
    st.markdown(
        """
        <style>
        body[data-current-page="reception"] .main .block-container {
            min-height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 2rem;
        }
        body[data-current-page="reception"] .reception-heading {
            font-size: clamp(1.9rem, 3vw + 1rem, 2.6rem);
            line-height: 1.35;
            color: #2f2311;
            margin-bottom: 0.25rem;
        }
        body[data-current-page="reception"] .reception-text {
            font-size: clamp(1.05rem, 1vw + 0.8rem, 1.25rem);
            color: #2f2311;
            margin: 0;
        }
        body[data-current-page="reception"] .reception-caption {
            color: #6b655d;
        }
        body[data-current-page="reception"] div[data-testid="baseButton-primary"] > button {
            border-radius: 999px;
            height: 3.4rem;
            font-size: 1.25rem;
        }
        body[data-current-page="reception"] div[data-testid="baseButton-secondary"] > button {
            border-radius: 999px;
            height: 3rem;
            font-size: 1.05rem;
        }
        body[data-current-page="reception"] .stTextInput input {
            border-radius: 14px;
            font-size: 1.3rem;
            padding: 0.8rem 1rem;
            text-align: center;
        }
        body[data-current-page="reception"] div[data-baseweb="select"] {
            border-radius: 14px;
            font-size: 1.3rem;
            min-height: 3.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body[data-current-page="reception"] .stSelectbox label,
        body[data-current-page="reception"] .stTextInput label {
            display: none;
        }
        body[data-current-page="reception"] .reception-photo-slot {
            width: 100%;
            max-width: 520px;
            height: min(48vh, 360px);
            margin: 0 auto 1.2rem;
            border-radius: 22px;
            border: 2px dashed #ccbfa4;
            background: #efe6d4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b6ab97;
            font-size: 1.1rem;
        }
        body[data-current-page="reception"] .wait-note {
            background: #d5e3c0;
            border-radius: 18px;
            padding: 1.5rem;
            margin: 0.5rem 0 1.5rem;
            font-size: 1.05rem;
            color: #2f2311;
        }
        </style>
        """,
        unsafe_allow_html=True
    )

    # ‰∏≠Â§ÆÂØÑ„Åõ„É¨„Ç§„Ç¢„Ç¶„Éà
    st.markdown("<div style='height:6vh'></div>", unsafe_allow_html=True)
    central_col = st.columns([0.08, 0.84, 0.08])[1]

    def render_reception_image(basename: str) -> None:
        if basename in {"name_prompt", "age_prompt"}:
            return
        if display_image("reception", basename, caption=None, fill='stretch'):
            return
        if basename == "cover":
            display_image("board", "okuchi_game", caption=None, fill='stretch')
            return
        if basename == "welcome_teeth":
            display_image("board", "welcome_teeth", caption=None, fill='stretch')
            return

    with central_col:
        if step == 0:
            render_reception_image("cover")
            st.markdown("<div style='height:2vh'></div>", unsafe_allow_html=True)
            if st.button("„ÅØ„Åò„ÇÅ„Çã", key="reception_next_cover", width='stretch', type="primary"):
                st.session_state.reception_step = 1
                st.rerun()

        elif step == 1:
            st.markdown("<h1 class='reception-heading'>„Åä„Åè„Å°„ÅÆ„Åò„Çì„Åõ„ÅÑ„Ç≤„Éº„É†„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ</h1>", unsafe_allow_html=True)
            render_reception_image("welcome_teeth")
            st.markdown("<p class='reception-text'>„Åø„Çì„Å™„Å´„ÅØ100„Åï„ÅÑ„Å´„Å™„Çã„Åæ„Åß<br>„Åç„Çå„ÅÑ„Å™„Åä„Åè„Å°„Åß„Åô„Åî„Åó„Å¶„ÇÇ„Çâ„ÅÜ„ÇàÔºÅ</p>", unsafe_allow_html=True)
            st.caption("‚Äª Èü≥Â£∞„Ç¨„Ç§„Éâ„ÅØÊ∫ñÂÇô‰∏≠„Å†„Çà„ÄÇ")
            st.markdown("<div style='height:1vh'></div>", unsafe_allow_html=True)
            if st.button("„Åô„Åô„ÇÄ", key="reception_next_welcome", width='stretch', type="primary"):
                st.session_state.reception_step = 2
                st.rerun()

        elif step == 2:
            render_reception_image("name_prompt")
            st.markdown("<h1 class='reception-heading'>„Åç„Åø„ÅÆ„Å™„Åæ„Åà„Çí<br>„Åä„Åó„Åà„Å¶ÔºÅ</h1>", unsafe_allow_html=True)
            name_input = st.text_input(
                "„Éã„ÉÉ„ÇØ„Éç„Éº„É†",
                value=st.session_state.participant_name,
                placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠",
                key="reception_name_input",
                label_visibility="collapsed"
            )
            if st.button("„Åô„Åô„ÇÄ", key="reception_next_name", width='stretch', type="primary"):
                if not name_input.strip():
                    st.warning("„Å™„Åæ„Åà„Çí„ÅÑ„Çå„Å¶„Å≠ÔºÅ")
                else:
                    st.session_state.participant_name = name_input.strip()
                    st.session_state.reception_step = 3
                    st.rerun()

        elif step == 3:
            render_reception_image("age_prompt")
            st.markdown("<h1 class='reception-heading'>„Å™„Çì„Åï„ÅÑ„Åã„Å™Ôºü</h1>", unsafe_allow_html=True)
            age_options = [f"{i}„Åï„ÅÑ" for i in range(0, 11)] + ["11„Åï„ÅÑ‰ª•‰∏ä"]
            default_label = st.session_state.reception_age_label
            if default_label not in age_options:
                default_label = "5„Åï„ÅÑ"
            age_index = age_options.index(default_label)
            selected_label = st.selectbox(
                "„Å™„Çì„Åï„ÅÑ„Åã„Å™Ôºü",
                age_options,
                index=age_index,
                key="reception_age_select",
                label_visibility="collapsed",
                help="„Éó„É´„ÉÄ„Ç¶„É≥„Åã„Çâ„Åà„Çâ„Çì„Åß„Å≠"
            )
            st.session_state.reception_age_label = selected_label
            if st.button("„Åô„Åô„ÇÄ", key="reception_next_age", width='stretch', type="primary"):
                if selected_label == "11„Åï„ÅÑ‰ª•‰∏ä":
                    participant_age = 11
                else:
                    participant_age = int(selected_label.replace("„Åï„ÅÑ", ""))
                st.session_state.participant_age = participant_age
                st.session_state.age_under_5 = participant_age < 5
                st.session_state.reception_step = 4
                st.rerun()

        elif step == 4:
            st.markdown("<h1 class='reception-heading'>„Åæ„Å£„Å¶„ÅÑ„Å¶„Å≠ÔºÅ</h1>", unsafe_allow_html=True)
            display_video(
                "reception",
                "wait_intro",
                caption=None,
                autoplay=True,
                loop=True,
                muted=True,
                controls=False,
                height=320,
            )
            st.markdown(
                "<div style='margin:1rem 0; text-align:center;'>"
                "<div class='loading-dots'><span></span><span></span><span></span></div>"
                "<p style='margin-top:0.5rem; color:#7b552e;'>„Åò„ÇÖ„Çì„Å≥„Åå„Åä„Çè„Å£„Åü„Çâ„Äå„Åô„Åô„ÇÄ„Äç„Çí„Åä„Åó„Å¶„Å≠„ÄÇ</p>"
                "</div>",
                unsafe_allow_html=True,
            )
            st.session_state.setdefault('reception_wait_unlocked', False)
            if not st.session_state.reception_wait_unlocked:
                pin = st.text_input("„Çπ„Çø„ÉÉ„ÉïÁî®„Éë„Çπ„Ç≥„Éº„Éâ", type="password", key="reception_wait_pin")
                if st.button("„Çπ„Çø„ÉÉ„ÉïÁ¢∫Ë™ç", key="reception_wait_check", type="secondary"):
                    settings = get_settings()
                    staff_pin = settings.get("staff_pin", "0418")
                    if pin == str(staff_pin):
                        st.session_state.reception_wait_unlocked = True
                        st.success("„Çπ„Çø„Éº„Éà„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„ÅüÔºÅ")
                    else:
                        st.error("PIN„Åå„Å°„Åå„ÅÜ„Çà„ÄÇ„ÇÇ„ÅÜ„ÅÑ„Å°„Å©Á¢∫Ë™ç„Åó„Å¶„Å≠„ÄÇ")

            if st.button("„Åô„Åô„ÇÄ", key="reception_start_game", width='stretch', type="primary", disabled=not st.session_state.reception_wait_unlocked):
                update_participant_count()
                st.session_state.reception_step = 0
                st.session_state.game_board_stage = 'card'
                st.session_state.pop('roulette_feedback', None)
                st.session_state.pop('roulette_last_spin_id', None)
                st.session_state.pop('reception_wait_unlocked', None)
                navigate_to('game_board')

    st.markdown("<div style='height:6vh'></div>", unsafe_allow_html=True)


def show_game_board_page():
    """„Ç≤„Éº„É†„Éú„Éº„Éâ„Éö„Éº„Ç∏Ôºà„Ç´„Éº„ÉâË°®Á§∫„Å®„É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢„Å´ÂàÜÈõ¢Ôºâ"""
    if 'game_state' not in st.session_state:
        from services.game_logic import initialize_game_state
        initialize_game_state()

    st.session_state.setdefault('game_board_stage', 'card')
    stage = st.session_state.game_board_stage

    # game_state„ÅØÂ∏∏„Å´st.session_state„Åã„ÇâÁõ¥Êé•ÂèÇÁÖß
    game_state = st.session_state.game_state
    current_position = game_state.get('current_position', 0)

    # „Éú„Éº„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    board_data = []
    current_cell = None
    max_position_index = 0
    forced_stop_indices = []
    required_stop_titles = {"Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫", "Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫", "„Åä‰ªï‰∫ã‰ΩìÈ®ì"}
    try:
        age_group = "under5" if st.session_state.participant_age < 5 else "5plus"
        board_file = f"data/board_main_{age_group}.json"
        with open(board_file, 'r', encoding='utf-8') as f:
            board_data = json.load(f)
        max_position_index = max(len(board_data) - 1, 0)
        if 0 <= current_position < len(board_data) and isinstance(board_data[current_position], dict):
            current_cell = board_data[current_position]
        forced_stop_indices = [
            idx for idx, cell in enumerate(board_data)
            if isinstance(cell, dict) and (
                cell.get('type') == 'stop'
                or cell.get('must_stop')
                or cell.get('force_stop')
                or cell.get('title') in required_stop_titles
            )
        ]
    except (FileNotFoundError, json.JSONDecodeError):
        board_data = []
        current_cell = None
        st.error("„Éú„Éº„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü")

    # „Çπ„ÉÜ„Éº„Ç∏Ë£úÊ≠£
    if stage not in {'card', 'roulette'}:
        stage = st.session_state.game_board_stage = 'card'

    def compute_allowed_numbers(position: int):
        distance_to_goal = max(0, max_position_index - position)
        if distance_to_goal <= 0:
            return [], None, distance_to_goal

        max_spin = 3
        max_reachable = min(max_spin, distance_to_goal)

        next_stop_distance = None
        for stop_pos in forced_stop_indices:
            if stop_pos > position:
                next_stop_distance = stop_pos - position
                break

        if next_stop_distance is not None and next_stop_distance > 0:
            limit = min(max_reachable, next_stop_distance)
        else:
            limit = max_reachable

        allowed = list(range(1, limit + 1))

        return allowed, next_stop_distance, distance_to_goal

    def render_cell_media(position: int, cell_info: dict) -> None:
        try:
            from services.image_helper import display_image
            cell_image_name = f"cell_{position + 1:02d}"
            if not display_image("board", cell_image_name, cell_info.get('title', ''), fill='stretch'):
                action_name = cell_info.get('action')
                action_to_image = {
                    'self_introduction': 'self_introduction',
                    'jump_exercise': 'jump',
                    'tooth_loss': 'tooth_loss',
                    'job_experience': 'job_experience'
                }
                if action_name in action_to_image:
                    display_image("events", action_to_image[action_name], cell_info.get('title', ''), fill='stretch')
        except ImportError:
            pass

    def process_spin_result(result_value: int):
        # ÊúÄÊñ∞„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
        old_position = st.session_state.game_state.get('current_position', 0)
        new_position = min(old_position + result_value, max_position_index)
        
        # game_state„ÇíÁõ¥Êé•Êõ¥Êñ∞
        st.session_state.game_state['current_position'] = new_position
        st.session_state.game_state['turn_count'] = st.session_state.game_state.get('turn_count', 0) + 1
        st.session_state.game_state['just_moved'] = True

        feedback = {
            'result': result_value,
            'old_position': old_position,
            'new_position': new_position,
            'move_message': f"‚û°Ô∏è {old_position + 1}„Å∞„Çì„ÇÅ ‚Üí {new_position + 1}„Å∞„Çì„ÇÅ „Å´„Åô„Åô„Çì„Å†„ÇàÔºÅ",
            'coin_messages': [],
            'tooth_messages': [],
            'landing_message': None,
            'landing_tone': None,
            'next_page': None,
            'next_button_label': "„Å§„Åé„ÅÆ„Éû„Çπ„Çí„Åø„Çã"
        }

        if board_data and 0 <= new_position < len(board_data):
            landing_cell = board_data[new_position]
            landing_title = landing_cell.get('title', '')
            landing_type = landing_cell.get('type', 'normal')

            tooth_delta = landing_cell.get('tooth_delta', 0)
            if tooth_delta != 0:
                old_coins = st.session_state.game_state.get('tooth_coins', 10)
                new_coins = max(0, old_coins + tooth_delta)
                st.session_state.game_state['tooth_coins'] = new_coins
                
                tone = 'success' if tooth_delta > 0 else 'warning'
                message = (f"üèÖ „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥„Çí {tooth_delta}Êûö „ÇÇ„Çâ„Å£„Åü„ÇàÔºÅÔºàÂêàË®à: {new_coins}ÊûöÔºâ" if tooth_delta > 0
                           else f"üíî „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥„Çí {abs(tooth_delta)}Êûö „ÅÜ„Åó„Å™„Å£„Åü...ÔºàÊÆã„Çä: {new_coins}ÊûöÔºâ")
                feedback['coin_messages'].append((tone, message))

            apply_tooth_effects(st.session_state.game_state, landing_cell, feedback)

            if feedback.get('next_page') is None:
                if landing_type == 'quiz':
                    if 'Ëô´Ê≠Ø' in landing_title:
                        feedback['landing_message'] = "ü¶∑ „ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„ÅÆ„Éû„Çπ„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ"
                        feedback['landing_tone'] = 'success'
                        feedback['next_page'] = 'caries_quiz'
                        feedback['next_button_label'] = "ü¶∑ „ÇØ„Ç§„Ç∫„Å∏„Åô„Åô„ÇÄ"
                    elif 'Ê≠ØÂë®ÁóÖ' in landing_title:
                        feedback['landing_message'] = "ü¶∑ „ÅØ„Åê„Åç„ÅÆ„ÇØ„Ç§„Ç∫„ÅÆ„Éû„Çπ„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ"
                        feedback['landing_tone'] = 'success'
                        feedback['next_page'] = 'perio_quiz'
                        feedback['next_button_label'] = "ü¶∑ „ÇØ„Ç§„Ç∫„Å∏„Åô„Åô„ÇÄ"
                elif landing_type == 'stop' or 'Ê§úË®∫' in landing_title:
                    feedback['landing_message'] = "üè• „ÅØ„ÅÑ„Åó„ÇÉ„Åï„Çì„ÅÆ„Éû„Çπ„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ"
                    feedback['landing_tone'] = 'success'
                    feedback['next_page'] = 'checkup'
                    feedback['next_button_label'] = "üè• „Åë„Çì„Åó„Çì„Å∏„Åô„Åô„ÇÄ"
                elif 'ËÅ∑Ê•≠' in landing_title:
                    if st.session_state.participant_age >= 5:
                        feedback['landing_message'] = "üë©‚Äç‚öïÔ∏è „Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„ÅÆ„Éû„Çπ„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ"
                        feedback['landing_tone'] = 'success'
                        feedback['next_page'] = 'job_experience'
                        feedback['next_button_label'] = "üë©‚Äç‚öïÔ∏è „Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„Å∏"
                    else:
                        feedback['landing_message'] = "„Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„ÅØ5„Åï„ÅÑ‰ª•‰∏ä„Å†„Çà„ÄÇ"
                        feedback['landing_tone'] = 'info'
                elif new_position >= max_position_index:
                    feedback['landing_message'] = "üèÅ „Ç¥„Éº„É´ÔºÅ„Åô„Åî„ÅÑ„Å≠ÔºÅ"
                    feedback['landing_tone'] = 'success'
                    feedback['next_page'] = 'goal'
                    feedback['next_button_label'] = "üèÅ „Ç¥„Éº„É´„Å∏„Åô„Åô„ÇÄ"
                    st.session_state.game_state['reached_goal'] = True
                    st.balloons()
            elif new_position >= max_position_index:
                feedback['landing_message'] = "üèÅ „Ç¥„Éº„É´ÔºÅ„Åô„Åî„ÅÑ„Å≠ÔºÅ"
                feedback['landing_tone'] = 'success'
                feedback['next_page'] = 'goal'
                feedback['next_button_label'] = "üèÅ „Ç¥„Éº„É´„Å∏„Åô„Åô„ÇÄ"
                st.session_state.game_state['reached_goal'] = True
                st.balloons()
        else:
            if old_position >= max_position_index:
                feedback['landing_message'] = "üèÅ „Ç¥„Éº„É´ÔºÅ„Åô„Åî„ÅÑ„Å≠ÔºÅ"
                feedback['landing_tone'] = 'success'
                feedback['next_page'] = 'goal'
                feedback['next_button_label'] = "üèÅ „Ç¥„Éº„É´„Å∏„Åô„Åô„ÇÄ"
                st.balloons()

        return feedback

    def finalize_spin(move_value: int):
        feedback = process_spin_result(move_value)
        st.session_state.roulette_recent_feedback = feedback
        st.session_state.pop('pending_spin_allowed', None)
        st.session_state.pop('roulette_spin_state', None)
        st.session_state.game_board_stage = 'card'

        next_page = feedback.get('next_page')
        if next_page and next_page != 'refresh':
            navigate_to(next_page)
        else:
            st.session_state.current_page = 'game_board'
            st.rerun()

    st.markdown("<div style='height:4vh'></div>", unsafe_allow_html=True)
    focus_col = st.columns([0.06, 0.88, 0.06])[1]

    with focus_col:
        if stage == 'card':
            recent_feedback = st.session_state.pop('roulette_recent_feedback', None)
            if recent_feedback:
                for tone, message in recent_feedback.get('coin_messages', []):
                    if tone == 'success':
                        st.success(message)
                    elif tone == 'warning':
                        st.warning(message)
                    else:
                        st.info(message)
                for tone, message in recent_feedback.get('tooth_messages', []):
                    if tone == 'success':
                        st.success(message)
                    elif tone == 'warning':
                        st.warning(message)
                    elif tone == 'error':
                        st.error(message)
                    else:
                        st.info(message)
                landing_message = recent_feedback.get('landing_message')
                if landing_message and recent_feedback.get('next_page') == 'refresh':
                    tone = recent_feedback.get('landing_tone', 'info')
                    if tone == 'success':
                        st.success(landing_message)
                    elif tone == 'warning':
                        st.warning(landing_message)
                    else:
                        st.info(landing_message)
            st.session_state.pop('roulette_feedback', None)
            st.session_state.pop('roulette_last_spin_id', None)
            if current_cell is None:
                st.warning("„Éû„Çπ„ÅÆÊÉÖÂ†±„Åå„Åø„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ")
                return

            total_cells = len(board_data)
            if total_cells:
                nodes_html = []
                for idx in range(total_cells):
                    classes = ["board-progress-node"]
                    if idx == current_position:
                        classes.append("is-current")
                    elif idx < current_position:
                        classes.append("is-visited")
                    nodes_html.append(f"<div class='{' '.join(classes)}'>{idx + 1}</div>")
                st.markdown(
                    f"<div class='board-progress-track'>{''.join(nodes_html)}</div>",
                    unsafe_allow_html=True,
                )

            render_cell_media(current_position, current_cell)

            cell_type = current_cell.get('type', 'normal')
            title = current_cell.get('title', '')
            action_taken = False

            event_effect_messages = {
                '„Ç∏„É£„É≥„Éó„Åå„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü': "„Ç∏„É£„É≥„Éó„Åß„Åã„Çâ„Å†„Çí„ÅÜ„Åî„Åã„Åó„Å¶ „Åí„Çì„Åç„ÅÑ„Å£„Å±„ÅÑÔºÅ",
                'Âàù„ÇÅ„Å¶‰π≥Ê≠Ø„ÅåÊäú„Åë„Åü': "„Å¨„Åë„ÅüÊ≠Ø„ÅÆ„Åä„ÅØ„Å™„Åó„Çí„Åó„Å¶ „Åü„ÅÑ„Åõ„Å§„Å´„Åó„Çà„ÅÜ„ÄÇ",
            }

            if cell_type == 'quiz':
                quiz_type = current_cell.get('quiz_type', '')
                if quiz_type == 'caries':
                    if st.button("ü¶∑ „ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ", width='stretch', type="primary"):
                        navigate_to('caries_quiz')
                        action_taken = True
                elif quiz_type == 'periodontitis':
                    if st.button("ü¶∑ „ÅØ„Åê„Åç„ÅÆ„ÇØ„Ç§„Ç∫„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ", width='stretch', type="primary"):
                        navigate_to('perio_quiz')
                        action_taken = True
            elif cell_type == 'stop' or 'Ê§úË®∫' in title:
                if st.button("üè• „ÅØ„ÅÑ„Åó„ÇÉ„Åï„Çì„Å´„ÅÑ„Åè", width='stretch', type="primary"):
                    navigate_to('checkup')
                    action_taken = True
            elif 'ËÅ∑Ê•≠' in title:
                if st.session_state.participant_age >= 5:
                    if st.button("üë©‚Äç‚öïÔ∏è „Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„Çí„Åô„Çã", width='stretch', type="primary"):
                        navigate_to('job_experience')
                        action_taken = True
                else:
                    st.info("„Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„ÅØ5„Åï„ÅÑ‰ª•‰∏ä„Å†„Çà„ÄÇ")
            elif cell_type == 'goal' or current_position == max_position_index:
                st.success("üéâ „Ç¥„Éº„É´„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ")
                if st.button("‚ñ∂Ô∏è „Ç¥„Éº„É´„Å∏", width='stretch', type="primary"):
                    navigate_to('goal')
                action_taken = True

            elif cell_type == 'event':
                event_button_text = {
                    'Âàù„ÇÅ„Å¶Ë®ÄËëâ„ÇíË©±„Åõ„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü': 'üó£Ô∏è „Åò„Åì„Åó„Çá„ÅÜ„Åã„ÅÑ„Çí„Åô„Çã',
                    '„Ç∏„É£„É≥„Éó„Åå„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Å£„Åü': 'ü§∏ „Ç∏„É£„É≥„Éó„Çí„Åô„Çã',
                    'Âàù„ÇÅ„Å¶‰π≥Ê≠Ø„ÅåÊäú„Åë„Åü': 'ü¶∑ „ÅØ„ÅÆ„Åä„ÅØ„Å™„Åó„Çí„Åô„Çã'
                }
                extra_caption = event_effect_messages.get(title)
                if extra_caption:
                    st.caption(extra_caption)
                if title in event_button_text:
                    if st.button(event_button_text[title], width='stretch', type='secondary', key=f'event_action_{current_position}'):
                        st.success('„Åü„ÅÆ„Åó„ÅÑ „Åü„ÅÑ„Åë„Çì„Åß„Åó„ÅüÔºÅ „Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥„ÅØ„Åù„ÅÆ„Åæ„Åæ„Å†„Çà„ÄÇ')
                        st.balloons()

            can_spin = (not action_taken and cell_type not in {'quiz', 'stop'}
                        and 'Ê§úË®∫' not in title and 'ËÅ∑Ê•≠' not in title
                        and current_position < max_position_index)

            if can_spin:
                allowed_numbers, _, _ = compute_allowed_numbers(current_position)
                if not allowed_numbers:
                    st.info("‰ªäÂõû„ÅØ„Åô„Åô„ÇÄ„Éû„Çπ„Åå„Å™„ÅÑ„Çà„ÄÇ")
                else:
                    st.markdown("<div style='height:1.5vh'></div>", unsafe_allow_html=True)
                    if st.button("üé° „É´„Éº„É¨„ÉÉ„Éà„Çí„Åæ„Çè„Åô", key="board_to_roulette", width='stretch', type="primary"):
                        st.session_state.pending_spin_allowed = allowed_numbers
                        st.session_state.pop('roulette_spin_state', None)
                        st.session_state.game_board_stage = 'roulette'
                        st.session_state.pop('roulette_recent_feedback', None)
                        st.rerun()
            elif not action_taken and current_position >= max_position_index:
                if st.button("üèÅ „Ç¥„Éº„É´„Å∏", width='stretch', type="primary"):
                    navigate_to('goal')

        elif stage == 'roulette':
            if current_position >= max_position_index or (current_cell and current_cell.get('type') == 'goal'):
                st.success("üéâ „Ç¥„Éº„É´„Å´„Å®„ÅÜ„Å°„ÇÉ„ÅèÔºÅ")
                if st.button("‚ñ∂Ô∏è „Ç¥„Éº„É´„Å∏", width='stretch', type="primary"):
                    st.session_state.game_board_stage = 'card'
                    navigate_to('goal')
                return

            allowed_numbers = st.session_state.get('pending_spin_allowed', [])

            if not allowed_numbers:
                st.session_state.game_board_stage = 'card'
                st.rerun()

            st.markdown("<h2 style='text-align:center; margin-bottom:1rem;'>„É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„Åù„ÅÜÔºÅ</h2>", unsafe_allow_html=True)

            spin_state = st.session_state.get('roulette_spin_state')

            if spin_state:
                snapshot = spin_state.get('allowed_snapshot') or []
                if set(snapshot) != set(allowed_numbers):
                    st.info("„Éú„Éº„Éâ„ÅÆÁä∂Ê≥Å„ÅåÂ§â„Çè„Å£„Åü„ÅÆ„Åß„ÄÅ„É´„Éº„É¨„ÉÉ„Éà„Çí„ÇÇ„ÅÜ„ÅÑ„Å°„Å©Áî®ÊÑè„Åô„Çã„Å≠„ÄÇ")
                    st.session_state.pop('roulette_spin_state', None)
                    st.rerun()

            def render_chips(active_value):
                display_numbers = [1, 2, 3]
                chips = []
                for num in display_numbers:
                    classes = ["roulette-number-chip"]
                    if active_value == num:
                        classes.append("is-active")
                    if num not in allowed_numbers:
                        classes.append("is-disabled")
                    classes_str = ' '.join(classes)
                    chips.append(f"<div class='{classes_str}' data-value='{num}'>{num}</div>")
                return ''.join(chips)

            def render_card(active_value, subtitle="„Åß„Çã„Åã„Åö", message="„Åß„ÅüÊï∞„Å†„Åë„ÄÅ„Ç≤„Éº„É†„Éú„Éº„Éâ„Åå„Åô„Åô„ÇÄ„ÇàÔºÅ"):
                return f"""
                    <div class="roulette-card">
                        <p class="roulette-subtitle">{subtitle}</p>
                        <div class="roulette-number-row">{render_chips(active_value)}</div>
                        <p style="margin:0; color:#7b552e;">{message}</p>
                    </div>
                """

            card_placeholder = st.empty()

            if not spin_state:
                card_placeholder.markdown(render_card(None), unsafe_allow_html=True)
                if st.button("üé° „É´„Éº„É¨„ÉÉ„Éà„ÇíÂõû„Åô", key="roulette_spin_button", type="primary"):
                    pool = allowed_numbers or [1]
                    animation_sequence = []
                    base_sequence = list(range(1, 4))
                    for _ in range(3):
                        animation_sequence.extend(base_sequence)
                    animation_sequence.extend(pool)
                    for value in animation_sequence:
                        card_placeholder.markdown(
                            render_card(value, subtitle="„É´„Éº„É¨„ÉÉ„Éà „Åè„Çã„Åè„Çã‚Ä¶", message="„Å©„ÅÆÊï∞Â≠ó„Å´„Å™„Çã„Åã„Å™Ôºü"),
                            unsafe_allow_html=True,
                        )
                        time.sleep(0.07)
                    result_value = pool[-1] if len(pool) == 1 else random.choice(pool)
                    st.session_state.roulette_spin_state = {
                        'status': 'result',
                        'value': result_value,
                        'allowed_snapshot': pool,
                        'timestamp': datetime.now().isoformat(),
                    }
                    st.rerun()
            else:
                if spin_state.get('status') != 'result':
                    st.session_state.pop('roulette_spin_state', None)
                    st.rerun()
                result_value = spin_state.get('value', allowed_numbers[0] if allowed_numbers else 1)
                card_placeholder.markdown(render_card(result_value), unsafe_allow_html=True)
                if st.button(f"{result_value}„Éû„Çπ„Åô„Åô„ÇÄ", key="roulette_apply", type="primary", use_container_width=True):
                    st.session_state.pop('roulette_spin_state', None)
                    finalize_spin(result_value)
                    return

    st.markdown("<div style='height:4vh'></div>", unsafe_allow_html=True)

def show_caries_quiz_page():
    """„ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„Éö„Éº„Ç∏"""
    from services.image_helper import display_image

    stage = st.session_state.get('caries_quiz_stage', 'intro')
    answers = st.session_state.setdefault('caries_quiz_answers', [None, None])

    if stage == 'intro':
        st.markdown("### ü¶∑ „ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫")
        st.caption("„Ç´„Éº„Éâ„ÇíË™≠„Çì„Å†„Çâ„ÄÅ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„ÇØ„Ç§„Ç∫„Å´„Åô„Åô„ÇÇ„ÅÜÔºÅ")
        try:
            display_image("board", "cell_06", "„ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„ÅÆ„Ç´„Éº„Éâ")
        except ImportError:
            st.markdown("„Ç´„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Åü„Åã„Å™Ôºü„ÇÄ„Åó„Å∞„Å´„Å§„ÅÑ„Å¶„ÅÆ„ÇØ„Ç§„Ç∫„Å´ÂÇô„Åà„Å¶„Å≠„ÄÇ")
        if st.button("ü¶∑ „ÇØ„Ç§„Ç∫„Å∏„Åô„Åô„ÇÄ", type="primary", use_container_width=True):
            st.session_state.caries_quiz_stage = 'question_0'
            st.session_state.caries_quiz_answers = [None, None]
            st.session_state.pop('caries_q1_selected', None)
            st.session_state.pop('caries_q2_selected', None)
            st.session_state.pop('caries_q1_checked', None)
            st.session_state.pop('caries_q2_checked', None)
            st.rerun()
        return

    if stage.startswith('question_'):
        try:
            question_index = int(stage.split('_')[1])
        except (IndexError, ValueError):
            question_index = 0

        st.markdown("### ü¶∑ „ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„Å´„Å°„Çá„ÅÜ„Åõ„ÇìÔºÅ")

        def render_option_buttons(options, selected, key_prefix):
            state_key = f"{key_prefix}_selected"
            if selected is None:
                selected = st.session_state.get(state_key)
            cols = st.columns(len(options))
            updated = selected
            for idx, label in enumerate(options):
                button_type = "primary" if selected == idx else "secondary"
                if cols[idx].button(label, key=f"{key_prefix}_btn_{idx}", use_container_width=True, type=button_type):
                    updated = idx
                    st.session_state[state_key] = idx
                    st.rerun()
            if updated is not None:
                st.session_state[state_key] = updated
            return updated

        if question_index == 0:
            if 'caries_q1_selected' not in st.session_state:
                st.session_state.caries_q1_selected = None
            st.markdown("---")
            st.markdown("**„ÇÇ„Çì„Å†„ÅÑ1: „Åã„Çâ„Å†„ÅÆ„Å™„Åã„Åß „ÅÑ„Å°„Å∞„Çì„Åã„Åü„ÅÑ„ÇÇ„ÅÆ„ÅØÔºü**")
            try:
                display_image("quiz/caries", "question_1", "ÂïèÈ°å1„ÅÆÁîªÂÉè")
            except ImportError:
                pass

            question1_options = ["„ÅÇ„Åü„Åæ", "„Åõ„Å™„Åã", "„ÅØ"]
            selected_idx = render_option_buttons(question1_options, answers[0], "caries_q1")
            answers[0] = selected_idx

            st.markdown("---")
            submit_q1 = st.button(
                "üìù „Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì",
                key="caries_submit_q1",
                type="primary",
                use_container_width=True,
            )

            if submit_q1:
                if answers[0] is None:
                    st.warning("„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ")
                else:
                    if answers[0] == 2:
                        st.success("„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Äé„ÅØ„Äè„ÅØ„Ç®„Éä„É°„É´„Åó„Å§„Åß „Åã„Çâ„Å†„ÅÆ„Å™„Åã„Åß „ÅÑ„Å°„Å∞„Çì„Åã„Åü„ÅÑ„Çì„Å†„Çà„ÄÇ")
                    else:
                        st.warning("„Åñ„Çì„Å≠„Çì‚Ä¶ „ÅÑ„Å°„Å∞„Çì„Åã„Åü„ÅÑ„ÅÆ„ÅØ„Äé„ÅØ„Äè„Å†„Çà„ÄÇ„Ç®„Éä„É°„É´„Åó„Å§„Åå „Å§„Çà„ÅÑ„Çì„Å†„ÄÇ")
                        st.info("‚úÖ „Åõ„ÅÑ„Åã„ÅÑ„ÅØ„Äé„ÅØ„Äè„Å†„Çà„ÄÇ")
                    st.session_state.caries_q1_checked = True

            if st.session_state.get('caries_q1_checked'):
                if st.button(
                    "‚ñ∂Ô∏è „Å§„Åé„ÅÆ„ÇÇ„Çì„Å†„ÅÑ„Å∏",
                    key="caries_next_q1",
                    type="secondary",
                    use_container_width=True,
                ):
                    st.session_state.pop('caries_q1_checked', None)
                    st.session_state.caries_quiz_stage = 'question_1'
                    st.rerun()
            else:
                st.caption("„Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì„Åó„Å¶„Åã„Çâ „Å§„Åé„Å∏„Åô„Åô„ÇÇ„ÅÜÔºÅ")
            return

        if question_index == 1:
            if 'caries_q2_selected' not in st.session_state:
                st.session_state.caries_q2_selected = None
            st.markdown("**„ÇÇ„Çì„Å†„ÅÑ2: „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ „Åè„Åø„ÅÇ„Çè„Åõ„ÅØÔºü**")
            try:
                display_image("quiz/caries", "question_2", "ÂïèÈ°å2„ÅÆÁîªÂÉè")
            except ImportError:
                pass

            if answers[1] is None:
                answers[1] = st.session_state.get('caries_q2_selected')

            combo_meta = [
                ("choco_banana", "„Ç≥„Éº„É©", "cola", "„ÉÅ„Éß„Ç≥„Éê„Éä„Éä + „Ç≥„Éº„É©"),
                ("cheese", "„Åä„Å°„ÇÉ", "tea", "„ÉÅ„Éº„Ç∫ + „Åä„Å°„ÇÉ"),
                ("bread", "„Éü„É´„ÇØ", "milk", "„Éë„É≥ + „Éü„É´„ÇØ"),
            ]

            st.markdown("**„Åà„Çâ„Çì„Åß„Å≠Ôºö**")
            try:
                option_cols = st.columns(len(combo_meta))
                for idx, (food_key, drink_label, drink_key, display_label) in enumerate(combo_meta):
                    with option_cols[idx]:
                        st.markdown(f"**{display_label}**")
                        food_col, drink_col = st.columns(2)
                        with food_col:
                            display_image("quiz/caries/food", food_key, display_label.split(" + ")[0])
                        with drink_col:
                            display_image("quiz/caries/drink", drink_key, drink_label)
                        button_type = "primary" if answers[1] == idx else "secondary"
                        if st.button(
                            "„Åì„ÅÆ„Åè„Åø„ÅÇ„Çè„Åõ„Å´„Åô„Çã",
                            key=f"caries_q2_btn_{idx}",
                            use_container_width=True,
                            type=button_type,
                        ):
                            answers[1] = idx
                            st.session_state['caries_q2_selected'] = idx
                            st.rerun()
            except ImportError:
                st.warning("ÁîªÂÉè„ÇíË°®Á§∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ")

            submit_q2 = st.button(
                "üìù „Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì",
                key="caries_submit_q2",
                type="primary",
                use_container_width=True,
            )

            if submit_q2:
                if answers[1] is None:
                    st.warning("„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ")
                else:
                    if answers[1] == 0:
                        st.success("„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅÇ„Åæ„ÅÑ„Åä„ÇÑ„Å§„Å® „ÅÇ„Åæ„ÅÑ„ÅÆ„Åø„ÇÇ„ÅÆ„ÅÆ„Åè„Åø„ÅÇ„Çè„Åõ„ÅØ „ÇÄ„Åó„Å∞„ÅÆ„Åç„Åë„Çì„Åå„Åü„Åã„ÅÑ„Çà„ÄÇ")
                    else:
                        st.warning("„Åñ„Çì„Å≠„Çì‚Ä¶ „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ„ÅÆ„ÅØ„Äé„ÉÅ„Éß„Ç≥„Éê„Éä„Éä + „Ç≥„Éº„É©„Äè„Å†„Çà„ÄÇ")
                        st.info("‚úÖ „Åõ„ÅÑ„Åã„ÅÑ„ÅØ„Äé„ÉÅ„Éß„Ç≥„Éê„Éä„Éä + „Ç≥„Éº„É©„Äè„Å†„Çà„ÄÇ")
                    st.session_state.caries_q2_checked = True

            finalize_pressed = False
            if st.session_state.get('caries_q2_checked'):
                finalize_pressed = st.button(
                    "‚ñ∂Ô∏è „Å§„Åé„Å∏",
                    key="caries_finalize_q2",
                    type="secondary",
                    use_container_width=True,
                )
            else:
                st.caption("„Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì„Åó„Å¶„Åã„Çâ „Åë„Å£„Å¶„ÅÑ„Åó„Çà„ÅÜÔºÅ")

            if finalize_pressed:
                st.session_state.pop('caries_q2_checked', None)
                correct_answers = [2, 0]
                correct_count = sum(
                    1
                    for i, correct_answer in enumerate(correct_answers)
                    if i < len(answers) and answers[i] == correct_answer
                )

                st.success(f"„Åõ„ÅÑ„Åã„ÅÑ„Åã„Åö: {correct_count}/2")

                try:
                    if correct_count >= 1:
                        st.markdown("### üåü „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ „Åè„Åø„ÅÇ„Çè„Åõ„Çí „Åø„Å§„Åë„Çâ„Çå„Åü„Å≠ÔºÅ")
                        st.warning("„Åì„Çå„ÅØ „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ„ÅÆ„Åß „Åç„Çí„Å§„Åë„Çà„ÅÜÔºÅ")
                        col1, col2 = st.columns(2)
                        with col1:
                            display_image("quiz/caries/food", "choco_banana", "„ÉÅ„Éß„Ç≥„Éê„Éä„ÉäÔºà„ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑÔºâ")
                        with col2:
                            display_image("quiz/caries/drink", "cola", "„Ç≥„Éº„É©Ôºà„ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑÔºâ")
                    else:
                        st.markdown("### üíß „Åì„Çå„ÅØ „ÇÄ„Åó„Å∞„Å´„Å™„Çä„Å´„Åè„ÅÑ„Çà")
                        st.info("„Åä„ÇÑ„Å§„ÇÑ„ÅÆ„Åø„ÇÇ„ÅÆ„ÅÆ „Åà„Çâ„Å≥„Åã„Åü„Çí „Åã„Çì„Åå„Åà„Å¶„Åø„Çà„ÅÜÔºÅ")
                        col1, col2 = st.columns(2)
                        with col1:
                            display_image("quiz/caries/food", "cheese", "„ÉÅ„Éº„Ç∫Ôºà„ÇÄ„Åó„Å∞„Å´„Å™„Çä„Å´„Åè„ÅÑÔºâ")
                        with col2:
                            display_image("quiz/caries/drink", "tea", "„Åä„Å°„ÇÉÔºà„ÇÄ„Åó„Å∞„Å´„Å™„Çä„Å´„Åè„ÅÑÔºâ")
                except ImportError:
                    pass

                selected_combo_idx = answers[1]
                if selected_combo_idx == 0:
                    st.success("‚úÖ „ÉÅ„Éß„Ç≥„Éê„Éä„Éä„Å®„Ç≥„Éº„É©„ÅØ „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ „Åè„Åø„ÅÇ„Çè„Åõ„Å†„Çà„ÄÇ„Åç„Çí„Å§„Åë„Çà„ÅÜ„Å≠ÔºÅ")
                else:
                    st.warning("‚ùå „Åà„Çâ„Çì„Å† „Åè„Åø„ÅÇ„Çè„Åõ„ÅØ „Åù„Åì„Åæ„Åß „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„Åè„Å™„ÅÑ„Çà„ÄÇ")

                if answers[0] == correct_answers[0]:
                    st.success("„ÇÇ„Çì„Å†„ÅÑ1„Åõ„ÅÑ„Åã„ÅÑÔºÅ„Äå„ÅØ„Äç„ÅØ„Ç®„Éä„É°„É´„Åó„Å§„Åß „Åã„Çâ„Å†„ÅÆ„Å™„Åã„Åß „ÅÑ„Å°„Å∞„Çì„Åã„Åü„ÅÑ„Çì„Å†„Çà„ÄÇ")
                else:
                    st.warning("„ÇÇ„Çì„Å†„ÅÑ1„ÅØ „Åñ„Çì„Å≠„Çì‚Ä¶ „ÅÑ„Å°„Å∞„Çì„Åã„Åü„ÅÑ„ÅÆ„ÅØ„Äå„ÅØ„Äç„Å†„Çà„ÄÇ„Ç®„Éä„É°„É´„Åó„Å§„Åå „Å§„Çà„ÅÑ„Çì„Å†„ÄÇ")

                if answers[1] == correct_answers[1]:
                    st.info("„ÇÇ„Çì„Å†„ÅÑ2„Åõ„ÅÑ„Åã„ÅÑÔºÅ„ÅÇ„Åæ„ÅÑ„ÉÅ„Éß„Ç≥„Éê„Éä„Éä„Å® „ÅÇ„Åæ„ÅÑ„ÅÆ„Åø„ÇÇ„ÅÆ„ÅÆ„Åè„Åø„ÅÇ„Çè„Åõ„ÅØ „ÇÄ„Åó„Å∞„Å´„Å™„Çä„ÇÑ„Åô„ÅÑ„Åã„Çâ „Åç„Çí„Å§„Åë„Çà„ÅÜ„ÄÇ")
                else:
                    st.info("„ÇÇ„Çì„Å†„ÅÑ2„ÅØ „ÇÇ„ÅÜ„Åô„Åì„ÅóÔºÅ „ÅÇ„Åæ„ÅÑ„ÇÇ„ÅÆ„Å® „ÅÇ„Åæ„ÅÑ„ÅÆ„Åø„ÇÇ„ÅÆ„Çí „ÅÇ„Çè„Åõ„Çã„Å® „ÇÄ„Åó„Å∞„ÅÆ„Åç„Åë„Çì„Åå „Åµ„Åà„Çã„Çà„ÄÇ")

                if 'game_state' in st.session_state:
                    game_state = st.session_state.game_state
                    old_coins = game_state.get('tooth_coins', 0)

                    if correct_count >= 1:
                        game_state['tooth_coins'] += 5
                        show_coin_change(old_coins, game_state['tooth_coins'], "„ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫ „Åõ„ÅÑ„Åã„ÅÑÔºÅ „Åç„Çí„Å§„Åë„Çâ„Çå„Åü„Å≠")
                        st.success("üåü „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ „Åë„Çì„Åì„ÅÜ„É´„Éº„Éà„Å´ „Åô„Åô„Åø„Åæ„ÅôÔºÅ")
                        game_state['current_position'] = 10
                    else:
                        game_state['tooth_coins'] = max(0, game_state['tooth_coins'] - 3)
                        show_coin_change(old_coins, game_state['tooth_coins'], "„ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫ „Åµ„Åõ„ÅÑ„Åã„ÅÑ... „Åç„Çí„Å§„Åë„Çà„ÅÜ")
                        st.warning("üíß „ÇÇ„ÅÜ„Åô„Åì„Åó „Åç„Çí„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ„Åπ„Å§„ÅÆ„É´„Éº„Éà„Å´ „Åô„Åô„Åø„Åæ„Åô„ÄÇ")
                        game_state['current_position'] = 7

                st.info("„Å§„Å•„Åç„ÅØ „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅßÔºÅ")
                st.session_state.caries_quiz_stage = 'intro'
                st.session_state.pop('caries_quiz_answers', None)
                st.session_state.pop('caries_q1_selected', None)
                st.session_state.pop('caries_q2_selected', None)
                navigate_to('game_board')
            return

def show_job_experience_page():
    """„Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì„Éö„Éº„Ç∏"""
    st.markdown("### üë©‚Äç‚öïÔ∏è „Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì")
    
    jobs = ["„ÅØ„ÅÑ„Åó„ÇÉ„Åï„Çì", "„ÅØ„ÅÆ„Åä„Åù„ÅÜ„Åò„ÅÆ„Åõ„Çì„Åõ„ÅÑ", "„ÅØ„Çí„Å§„Åè„Çã„Åõ„Çì„Åõ„ÅÑ"]
    
    if 'selected_job' not in st.session_state:
        st.session_state.selected_job = None
    
    if st.session_state.selected_job is None:
        st.markdown("„Åè„Åò„Çí„Å≤„ÅÑ„Å¶ „Åä„Åó„Åî„Å®„Çí„Åç„ÇÅ„Çà„ÅÜÔºÅ")
        
        if st.button("üéØ „Åè„Åò„Çí„Å≤„Åè", width='stretch', type="primary"):
            import random
            job_index = random.randint(0, 2)
            st.session_state.selected_job = jobs[job_index]
            st.success(f"üéâ {st.session_state.selected_job}„Å´„Åç„Åæ„Å£„Åü„ÇàÔºÅ")
            st.rerun()
    else:
        st.info(f"„Åü„ÅÑ„Åë„Çì„Åô„Çã„Åä„Åó„Åî„Å®: {st.session_state.selected_job}")
        st.markdown("1„Å∑„Çì„Åã„Çì „Åü„ÅÑ„Åë„Çì„Çí„Åó„Åæ„Åô...")
        
        if st.button("‚úÖ „Åü„ÅÑ„Åë„Çì„Åã„Çì„Çä„Çá„ÅÜ", width='stretch', type="primary"):
            # ‰ΩìÈ®ìÂÆå‰∫ÜÂ†±ÈÖ¨
            if 'game_state' in st.session_state:
                game_state = st.session_state.game_state
                old_coins = game_state.get('tooth_coins', 0)
                game_state['tooth_coins'] += 5
                
                # „Ç≥„Ç§„É≥Â¢óÂä†„ÇíË°®Á§∫
                show_coin_change(old_coins, game_state['tooth_coins'], "„Åä„Åó„Åî„Å®„Åü„ÅÑ„Åë„Çì „ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ")
            
            st.session_state.selected_job = None  # „É™„Çª„ÉÉ„Éà
            navigate_to('checkup')

def show_checkup_page():
    """„Å¶„ÅÑ„Åç„Åë„Çì„Åó„Çì„Éö„Éº„Ç∏"""
    try:
        from services.image_helper import display_image
        display_image("board", "cell_05", caption=None, fill='stretch')
    except ImportError:
        pass
    
    if st.button("üè• „Åë„Çì„Åó„Çì„Çí„ÅÜ„Åë„Çã", width='stretch', type="primary"):
        # ÂÅ•Ë®∫Â†±ÈÖ¨
        if 'game_state' in st.session_state:
            game_state = st.session_state.game_state
            old_coins = game_state.get('tooth_coins', 0)
            game_state['tooth_coins'] += 3
            current_position = game_state.get('current_position', 0)
            
            # „Ç≥„Ç§„É≥Â¢óÂä†„ÇíË°®Á§∫
            show_coin_change(old_coins, game_state['tooth_coins'], "„Å¶„ÅÑ„Åç„Åë„Çì„Åó„Çì „ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ")
            
            # „Éú„Éº„Éâ„Éá„Éº„Çø„Åã„ÇâÁèæÂú®„ÅÆ„Çª„É´„ÅÆÊ¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            try:
                import json
                age_group = "under5" if st.session_state.participant_age < 5 else "5plus"
                board_file = f"data/board_main_{age_group}.json"
                
                with open(board_file, 'r', encoding='utf-8') as f:
                    board_data = json.load(f)
                
                current_cell = None
                for cell in board_data:
                    if cell['cell'] == current_position:
                        current_cell = cell
                        break
                
                if current_cell and current_cell.get('next_action'):
                    next_action = current_cell['next_action']
                    if next_action == 'caries_quiz':
                        st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                        st.info("„Å§„Åé„ÅØ „ÇÄ„Åó„Å∞„ÇØ„Ç§„Ç∫„Å´ „Å°„Çá„ÅÜ„Åõ„Çì„Åó„Çà„ÅÜÔºÅ")
                        navigate_to('caries_quiz')
                    elif next_action == 'periodontitis_quiz':
                        st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                        st.info("„Å§„Åé„ÅØ „ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫„Å´ „Å°„Çá„ÅÜ„Åõ„Çì„Åó„Çà„ÅÜÔºÅ")
                        navigate_to('perio_quiz')
                    else:
                        st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                        st.info("„Å§„Å•„Åç„ÅØ „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅßÔºÅ")
                        navigate_to('game_board')
                else:
                    # ‰ΩçÁΩÆ15„ÅÆÂ†¥Âêà„ÅØÊ≠ØËåé„ÇØ„Ç§„Ç∫„Å´ÈÄ≤„ÇÄ
                    if current_position == 15:
                        st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                        st.info("„Å§„Åé„ÅØ „ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫„Å´ „Å°„Çá„ÅÜ„Åõ„Çì„Åó„Çà„ÅÜÔºÅ")
                        navigate_to('perio_quiz')
                    else:
                        st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                        st.info("„Å§„Å•„Åç„ÅØ „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅßÔºÅ")
                        navigate_to('game_board')
                    
            except (FileNotFoundError, json.JSONDecodeError):
                st.success("üéâ +3„Ç≥„Ç§„É≥„Ç≤„ÉÉ„ÉàÔºÅ")
                st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
                st.info("„Å§„Å•„Åç„ÅØ „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅßÔºÅ")
                navigate_to('game_board')
        else:
            st.success("„Åë„Çì„Åó„Çì „Åã„Çì„Çä„Çá„ÅÜÔºÅ")
            navigate_to('game_board')

def show_perio_quiz_page():
    """„ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫„Éö„Éº„Ç∏"""
    questions = [
        {"q": "„ÅØ„Åø„Åå„Åç„Åó„Å™„ÅÑ„Å® „Å©„Åì„Åã„Çâ „Å°„Åå„Åß„ÇãÔºü", "options": ["„ÅØ", "„ÅØ„Åê„Åç", "„Åó„Åü"], "correct": 1},
        {"q": "„ÅØ„ÅÆ „Å≠„Å£„Åì„ÅÆ „Å®„Åì„Çç„ÅØ „Å©„ÅÜ„Å™„Å£„Å¶„ÇãÔºü", "options": ["‚ë†", "‚ë°", "‚ë¢"], "correct": 2}
    ]

    stage = st.session_state.get('perio_quiz_stage', 'intro')
    if stage == 'questions':
        stage = 'question_0'
        st.session_state.perio_quiz_stage = stage

    if stage == 'intro':
        st.markdown("### ü¶∑ „ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫")
        st.caption("„Ç´„Éº„Éâ„Çí„Çà„Çì„Å†„Çâ„ÄÅ„Éú„Çø„É≥„Çí„Åä„Åó„Å¶„ÇØ„Ç§„Ç∫„Å´„Åô„Åô„ÇÇ„ÅÜÔºÅ")
        try:
            from services.image_helper import display_image
            display_image("quiz/periodontitis", "main_image", "„ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫„ÅÆ„Ç´„Éº„Éâ")
        except ImportError:
            st.info("„Ç´„Éº„Éâ„Çí„Çà„Çì„Åß „ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫„ÅÆ„Åò„ÇÖ„Çì„Å≥„Çí„Åó„Çà„ÅÜ„ÄÇ")
        if st.button("ü¶∑ „ÇØ„Ç§„Ç∫„Å∏„Åô„Åô„ÇÄ", type="primary", use_container_width=True):
            st.session_state.perio_quiz_stage = 'question_0'
            st.session_state.perio_quiz_answers = [None] * len(questions)
            st.session_state.pop('perio_q1_selected', None)
            st.session_state.pop('perio_q2_selected', None)
            st.session_state.pop('perio_q1_checked', None)
            st.session_state.pop('perio_q2_checked', None)
            st.rerun()
        return

    st.markdown("### ü¶∑ „ÅØ„Åê„Åç„ÇØ„Ç§„Ç∫")
    
    answers = st.session_state.setdefault('perio_quiz_answers', [None] * len(questions))

    def render_option_buttons(options, selected, key_prefix):
        state_key = f"{key_prefix}_selected"
        if selected is None:
            selected = st.session_state.get(state_key)
        cols = st.columns(len(options))
        updated = selected
        for idx, label in enumerate(options):
            button_type = "primary" if selected == idx else "secondary"
            if cols[idx].button(label, key=f"{key_prefix}_btn_{idx}", use_container_width=True, type=button_type):
                updated = idx
                st.session_state[state_key] = idx
                st.rerun()
        if updated is not None:
            st.session_state[state_key] = updated
        return updated

    if stage.startswith('question_'):
        try:
            question_index = int(stage.split('_')[1])
        except (IndexError, ValueError):
            question_index = 0

        st.caption(f"„ÇÇ„Çì„Å†„ÅÑ {question_index + 1} / {len(questions)}")
        st.markdown("---")

        if question_index == 0:
            if 'perio_q1_selected' not in st.session_state:
                st.session_state.perio_q1_selected = None
            st.markdown("**ÂïèÈ°å1: „ÅØ„Åê„Åç„ÅÆÁä∂ÊÖã„ÇíÊØî„Åπ„Å¶„Åø„Çà„ÅÜ**")
            try:
                from services.image_helper import display_image
                col1, col2 = st.columns(2)
                with col1:
                    display_image("quiz/periodontitis", "question_1a", "ÂïèÈ°å")
                with col2:
                    display_image("quiz/periodontitis", "question_1b", "„ÅØ„Åê„Åç„ÅÆÁä∂ÊÖã")
            except ImportError:
                pass

            st.markdown(f"**„ÇÇ„Çì„Å†„ÅÑ1: {questions[0]['q']}**")
            answers[0] = render_option_buttons(questions[0]['options'], answers[0], "perio_q1")

            st.markdown("---")
            submit_q1 = st.button(
                "üìù „Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì",
                key="perio_submit_q1",
                type="primary",
                use_container_width=True,
            )

            if submit_q1:
                if answers[0] is None:
                    st.warning("„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ")
                else:
                    if answers[0] == questions[0]['correct']:
                        st.success("„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅØ„Åø„Åå„Åç„Åó„Å™„ÅÑ„Å® „ÅØ„Åê„Åç„Åã„Çâ „Å°„Åå„Åß„Çã„Åì„Å®„Åå „ÅÇ„Çã„Çì„Å†„Çà„ÄÇ")
                    else:
                        st.warning("„Åñ„Çì„Å≠„Çì‚Ä¶ „ÅØ„Åê„Åç„Åã„Çâ „Å°„Åå„Åß„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„Åå„ÅÇ„Çã„Åã„Çâ „Å¶„ÅÑ„Å≠„ÅÑ„Å´„ÅØ„Åø„Åå„Åç„Åó„Çà„ÅÜ„Å≠„ÄÇ")
                        st.info("‚úÖ „Åõ„ÅÑ„Åã„ÅÑ„ÅØ„Äé„ÅØ„Åê„Åç„Äè„Å†„Çà„ÄÇ")
                    st.session_state.perio_q1_checked = True

            if st.session_state.get('perio_q1_checked'):
                if st.button(
                    "‚ñ∂Ô∏è „Å§„Åé„ÅÆ„ÇÇ„Çì„Å†„ÅÑ„Å∏",
                    key="perio_next_q1",
                    type="secondary",
                    use_container_width=True,
                ):
                    st.session_state.pop('perio_q1_checked', None)
                    st.session_state.perio_quiz_stage = 'question_1'
                    st.rerun()
            else:
                st.caption("„Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì„Åó„Å¶„Åã„Çâ „Å§„Åé„Å∏„Åô„Åô„ÇÇ„ÅÜÔºÅ")
            return

        if question_index == 1:
            if 'perio_q2_selected' not in st.session_state:
                st.session_state.perio_q2_selected = None
            st.markdown("**ÂïèÈ°å2: „ÇÇ„ÅÜ‰∏Ä„Å§„ÅÆÊØîËºÉÂïèÈ°å**")
            try:
                from services.image_helper import display_image
                col3, col4 = st.columns(2)
                with col3:
                    display_image("quiz/periodontitis", "question_2a", "„ÅØ„Åê„Åç„ÅÆÁä∂ÊÖãC")
                with col4:
                    display_image("quiz/periodontitis", "question_2b", "„ÅØ„Åê„Åç„ÅÆÁä∂ÊÖãD")
            except ImportError:
                pass

            st.markdown(f"**„ÇÇ„Çì„Å†„ÅÑ2: {questions[1]['q']}**")
            answers[1] = render_option_buttons(questions[1]['options'], answers[1], "perio_q2")

            st.markdown("---")
            submit_q2 = st.button(
                "üìù „Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì",
                key="perio_submit_q2",
                type="primary",
                use_container_width=True,
            )

            if submit_q2:
                if answers[1] is None:
                    st.warning("„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ")
                else:
                    if answers[1] == questions[1]['correct']:
                        st.success("„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅØ„ÅÆ„Å≠„ÇÇ„Å®„ÅØ „Åª„Å≠„Å® „ÅØ„Åê„Åç„Åß „Åó„Å£„Åã„Çä „Åï„Åï„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Çà„ÄÇ")
                    else:
                        st.warning("„Åñ„Çì„Å≠„Çì‚Ä¶ „ÅØ„ÅÆ„Å≠„ÇÇ„Å®„ÅØ „Åª„Å≠„Å® „ÅØ„Åê„Åç„Åß „Åï„Åï„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Çì„Å†„ÄÇ")
                        st.info("‚úÖ „Åõ„ÅÑ„Åã„ÅÑ„ÅØ„Äé‚ë¢„Äè„Å†„Çà„ÄÇ")
                    st.session_state.perio_q2_checked = True

            finalize_perio = False
            if st.session_state.get('perio_q2_checked'):
                finalize_perio = st.button(
                    "‚ñ∂Ô∏è „Å§„Åé„Å∏",
                    key="perio_finalize_q2",
                    type="secondary",
                    use_container_width=True,
                )
            else:
                st.caption("„Åì„Åü„Åà„Çí„Åã„Åè„Å´„Çì„Åó„Å¶„Åã„Çâ „Åë„Å£„Å¶„ÅÑ„Åó„Çà„ÅÜÔºÅ")

            if finalize_perio:
                st.session_state.pop('perio_q2_checked', None)
                if answers[1] is None:
                    st.warning("„Åì„Åü„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ")
                    return

                correct_count = sum(
                    1
                    for i, q in enumerate(questions)
                    if i < len(answers) and answers[i] == q['correct']
                )

                st.success(f"„Åõ„ÅÑ„Åã„ÅÑ„Åã„Åö: {correct_count}/{len(questions)}")

                if answers[0] == questions[0]['correct']:
                    st.success("„ÇÇ„Çì„Å†„ÅÑ1„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅØ„Åø„Åå„Åç„Åó„Å™„ÅÑ„Å® „ÅØ„Åê„Åç„Åã„Çâ „Å°„Åå„Åß„Çã„Åì„Å®„Åå „ÅÇ„Çã„Çì„Å†„Çà„ÄÇ")
                else:
                    st.warning("„ÇÇ„Çì„Å†„ÅÑ1„ÅØ „Åñ„Çì„Å≠„Çì‚Ä¶ „ÅØ„Åê„Åç„Åã„Çâ „Å°„Åå„Åß„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„Åå„ÅÇ„Çã„Åã„Çâ „Å¶„ÅÑ„Å≠„ÅÑ„Å´„ÅØ„Åø„Åå„Åç„Åó„Çà„ÅÜ„Å≠„ÄÇ")

                if answers[1] == questions[1]['correct']:
                    st.info("„ÇÇ„Çì„Å†„ÅÑ2„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅØ„ÅÆ„Å≠„ÇÇ„Å®„ÅØ „Åó„Å£„Åã„Çä „ÅØ„Åê„Åç„ÇÑ „Åª„Å≠„Åß „Åï„Åï„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Çà„ÄÇ")
                else:
                    st.info("„ÇÇ„Çì„Å†„ÅÑ2„ÅØ „ÇÇ„ÅÜ„Åô„Åì„ÅóÔºÅ „ÅØ„ÅÆ„Å≠„ÇÇ„Å®„ÅØ „Åª„Å≠„Å® „ÅØ„Åê„Åç„Åß „Åï„Åï„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Çì„Å†„ÄÇ")

                if 'game_state' in st.session_state:
                    game_state = st.session_state.game_state
                    old_coins = game_state['tooth_coins']

                    if correct_count >= 1:
                        game_state['tooth_coins'] += 5
                        show_coin_change(old_coins, game_state['tooth_coins'], "üåü „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ")
                        st.balloons()
                    else:
                        game_state['tooth_coins'] = max(0, game_state['tooth_coins'] - 3)
                        show_coin_change(old_coins, game_state['tooth_coins'], "üíß „ÇÇ„ÅÜ„Åô„Åì„Åó „Åπ„Çì„Åç„Çá„ÅÜ„Åó„Çà„ÅÜ„Å≠")

                    game_state['current_position'] = 19

                st.session_state.perio_quiz_stage = 'intro'
                st.session_state.pop('perio_quiz_answers', None)
                st.session_state.pop('perio_q1_selected', None)
                st.session_state.pop('perio_q2_selected', None)
                st.session_state.pop('perio_q1_checked', None)
                st.session_state.pop('perio_q2_checked', None)
                st.info("„Å§„Å•„Åç„ÅØ „Ç≤„Éº„É†„Éú„Éº„Éâ„ÅßÔºÅ")
                navigate_to('game_board')
            return

def show_goal_page():
    """„Ç¥„Éº„É´„Éª„É©„É≥„Ç≠„É≥„Ç∞„Éö„Éº„Ç∏"""
    st.markdown("### üèÅ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ")
    
    if 'game_state' in st.session_state:
        game_state = st.session_state.game_state
        
        col1, col2 = st.columns(2)
        with col1:
            st.metric("„Åï„ÅÑ„Åó„ÇÖ„ÅÜ„ÅØ„ÅÆ„Åã„Åö", f"{game_state.get('teeth_count', 20)}„Åª„Çì")
        with col2:
            st.metric("„Éà„Ç•„Éº„Çπ„Ç≥„Ç§„É≥", f"{game_state.get('tooth_coins', 10)}„Åæ„ÅÑ")
    
    st.success("„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ")
    
    if st.button("üì± LINE„Éö„Éº„Ç∏„Å∏", width='stretch', type="secondary"):
        navigate_to('line_coloring')

def show_line_coloring_page():
    """LINE„Éª„Å¨„Çä„Åà„Éö„Éº„Ç∏"""
    st.markdown("### üì± LINEÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà")
    
    st.info("LINEÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„Éï„Ç©„É≠„Éº„Åó„Çà„ÅÜÔºÅ„ÅäÂè£„ÅÆÂÅ•Â∫∑„Å´Èñ¢„Åô„ÇãÊÉÖÂ†±„ÇÑÊ•Ω„Åó„ÅÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÅäÂ±ä„Åë„Åó„Åæ„ÅôÔºÅ")
    
    # LINE„Å∏„ÅÆË™òÂ∞é„Éú„Çø„É≥
    st.markdown("""
    <div style='text-align: center; margin: 20px 0;'>
        <a href="https://line.me/R/ti/p/@551bgrrd" target="_blank" style="text-decoration: none;">
            <div style='
                background: linear-gradient(135deg, #00B900, #00C300);
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                font-size: 1.2em;
                font-weight: bold;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
                display: inline-block;
                width: 100%;
                max-width: 400px;
            '>
                üì± LINEÂÖ¨Âºè„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„Éï„Ç©„É≠„Éº
            </div>
        </a>
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("""
    <p style='text-align: center; color: #666; font-size: 0.9em; margin: 10px 0;'>
        „Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®LINE„Ç¢„Éó„É™„Åæ„Åü„ÅØÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßLINE„Éö„Éº„Ç∏„ÅåÈñã„Åç„Åæ„Åô
    </p>
    """, unsafe_allow_html=True)
    
    if st.button("üè† „Åï„ÅÑ„Åó„Çá„Åã„Çâ„ÇÇ„ÅÜ„ÅÑ„Å°„Å©", width='stretch'):
        # „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        for key in list(st.session_state.keys()):
            if key.startswith(('game_state', 'quiz_', 'selected_job')):
                del st.session_state[key]
        navigate_to('reception')

def show_staff_management_page():
    """„Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Éö„Éº„Ç∏"""
    st.markdown("### ‚öôÔ∏è „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ")
    
    # PINË™çË®º
    pin = st.text_input("PIN„Ç≥„Éº„Éâ", type="password")
    
    if pin == "0418":
        st.success("‚úÖ Ë™çË®ºÊàêÂäü")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üóëÔ∏è ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà"):
                for key in list(st.session_state.keys()):
                    del st.session_state[key]
                st.success("„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü")
                navigate_to('reception')
        
        with col2:
            if st.button("üß™ ÁîªÂÉè„ÉÜ„Çπ„Éà"):
                navigate_to('image_test')
    elif pin:
        st.error("‚ùå PIN„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì")
    
    if st.button("üè† „É°„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã"):
        navigate_to('reception')

def show_image_test_page():
    """ÁîªÂÉè„ÉÜ„Çπ„Éà„Éö„Éº„Ç∏"""
    st.title("üß™ ÁîªÂÉè„ÉÜ„Çπ„Éà")
    st.markdown("---")
    
    try:
        from services.image_helper import display_image
        
        # „Éú„Éº„ÉâÁîªÂÉè„ÉÜ„Çπ„Éà
        st.subheader("1. „Éú„Éº„Éâ„Éû„ÇπÁîªÂÉè„ÉÜ„Çπ„Éà")
        board_images = ["cell_01", "cell_02", "cell_03", "cell_04", "cell_05"]
        for cell_name in board_images:
            display_image("board", cell_name, f"„Éú„Éº„Éâ„Éû„ÇπÁîªÂÉè: {cell_name}")
        
        # „ÇØ„Ç§„Ç∫ÁîªÂÉè„ÉÜ„Çπ„Éà
        st.subheader("2. „ÇØ„Ç§„Ç∫ÁîªÂÉè„ÉÜ„Çπ„Éà")
        
        # Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫„É°„Ç§„É≥ÁîªÂÉè
        st.markdown("**Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫ - „É°„Ç§„É≥ÁîªÂÉè**")
        display_image("quiz/caries", "main_image", "Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫„É°„Ç§„É≥ÁîªÂÉè")
        
        # Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫ÂïèÈ°åÁîªÂÉè
        st.markdown("**Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫ - ÂïèÈ°åÁîªÂÉè**")
        display_image("quiz/caries", "question_1", "Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫ÂïèÈ°å1")
        display_image("quiz/caries", "question_2", "Ëô´Ê≠Ø„ÇØ„Ç§„Ç∫ÂïèÈ°å2")
        
        # È£ü„ÅπÁâ©ÈÅ∏ÊäûËÇ¢ÔºàJPEGÂØæÂøúÔºâ
        st.markdown("**È£ü„ÅπÁâ©ÈÅ∏ÊäûËÇ¢ (JPEGÂΩ¢Âºè)**")
        food_items = ["bread", "choco_banana", "cheese", "xylitol_gum"]
        cols = st.columns(4)
        for i, food in enumerate(food_items):
            with cols[i]:
                display_image("quiz/caries/food", food, f"{food}")
        
        # È£≤„ÅøÁâ©ÈÅ∏ÊäûËÇ¢ÔºàJPEGÂØæÂøúÔºâ
        st.markdown("**È£≤„ÅøÁâ©ÈÅ∏ÊäûËÇ¢ (JPEGÂΩ¢Âºè)**")
        drink_items = ["tea", "cola", "orange_juice", "black_coffee", "milk"]
        cols = st.columns(5)
        for i, drink in enumerate(drink_items):
            with cols[i]:
                display_image("quiz/caries/drink", drink, f"{drink}")
        
        # Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫
        st.markdown("**Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫**")
        display_image("quiz/periodontitis", "main_image", "Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫„É°„Ç§„É≥ÁîªÂÉè")
        display_image("quiz/periodontitis", "question_1", "Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫ÂïèÈ°å1")
        display_image("quiz/periodontitis", "question_2", "Ê≠ØÂë®ÁóÖ„ÇØ„Ç§„Ç∫ÂïèÈ°å2")
        
        # „Ç§„Éô„É≥„ÉàÁîªÂÉè„ÉÜ„Çπ„Éà
        st.subheader("3. „Ç§„Éô„É≥„ÉàÁîªÂÉè„ÉÜ„Çπ„Éà")
        event_images = ["self_introduction", "jump", "tooth_loss", "job_experience"]
        for event_name in event_images:
            display_image("events", event_name, f"„Ç§„Éô„É≥„ÉàÁîªÂÉè: {event_name}")
        
        # ÂÆöÊúüÊ§úË®∫ÁîªÂÉè„ÉÜ„Çπ„Éà
        st.subheader("4. ÂÆöÊúüÊ§úË®∫ÁîªÂÉè„ÉÜ„Çπ„Éà")
        checkup_images = ["main_checkup", "examination", "brushing_instruction", 
                         "professional_cleaning", "fluoride_treatment", 
                         "checkup_result", "importance"]
        for checkup_name in checkup_images:
            display_image("checkup", checkup_name, f"ÂÆöÊúüÊ§úË®∫ÁîªÂÉè: {checkup_name}")
        
        st.success("„Åô„Åπ„Å¶„ÅÆÁîªÂÉè„Ç´„ÉÜ„Ç¥„É™„Çí„ÉÜ„Çπ„Éà„Åó„Åæ„Åó„Åü„ÄÇ‰∏äË®ò„ÅßË°®Á§∫„Åï„Çå„Å™„ÅÑÁîªÂÉè„ÅØ„ÄÅÂØæÂøú„Åô„Çã„Éï„Ç°„Ç§„É´„Åå assets/images/ „Éï„Ç©„É´„ÉÄ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ")
        
    except ImportError:
        st.error("image_helper „É¢„Ç∏„É•„Éº„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì")
    
    # „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
    st.markdown("---")
    col1, col2 = st.columns(2)
    with col1:
        if st.button("‚Üê „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Å´Êàª„Çã", width='stretch'):
            navigate_to('staff_management')
    with col2:
        if st.button("üè† Âèó‰ªò„Å´Êàª„Çã", width='stretch'):
            navigate_to('reception')

# „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
def main():
    # „Çø„Ç§„Éà„É´Ë°®Á§∫
    current_page_info = PAGE_FLOW.get(st.session_state.current_page, {'title': '„ÅäÂè£„ÅÆ‰∫∫Áîü„Ç≤„Éº„É†'})
    staff_mode = staff_access_enabled()

    if st.session_state.current_page != 'reception':
        caries_intro = (
            st.session_state.current_page == 'caries_quiz'
            and st.session_state.get('caries_quiz_stage', 'intro') == 'intro'
        )

        hide_progress_pages = {'game_board', 'checkup', 'perio_quiz', 'caries_quiz', 'goal', 'line_coloring'}
        if st.session_state.current_page not in hide_progress_pages and not caries_intro:
            st.markdown(f"<h1 class='main-title'>{current_page_info['title']}</h1>", unsafe_allow_html=True)
            show_progress_bar()

        hide_status_pages = {'caries_quiz', 'perio_quiz'}
        if not caries_intro and st.session_state.current_page not in hide_status_pages:
            show_status_header()
    
    # ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Å´Âøú„Åò„Å¶„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
    if st.session_state.current_page == 'reception':
        show_reception_page()
    elif st.session_state.current_page == 'game_board':
        show_game_board_page()
    elif st.session_state.current_page == 'caries_quiz':
        show_caries_quiz_page()
    elif st.session_state.current_page == 'job_experience':
        show_job_experience_page()
    elif st.session_state.current_page == 'checkup':
        show_checkup_page()
    elif st.session_state.current_page == 'perio_quiz':
        show_perio_quiz_page()
    elif st.session_state.current_page == 'goal':
        show_goal_page()
    elif st.session_state.current_page == 'line_coloring':
        show_line_coloring_page()
    elif st.session_state.current_page == 'staff_management':
        if staff_mode:
            show_staff_management_page()
        else:
            st.warning("„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØ„Çπ„Çø„ÉÉ„ÉïÂ∞ÇÁî®„Å†„Çà„ÄÇ")
            navigate_to('reception')
    elif st.session_state.current_page == 'image_test':
        if staff_mode:
            show_image_test_page()
        else:
            st.warning("„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØ„Çπ„Çø„ÉÉ„ÉïÂ∞ÇÁî®„Å†„Çà„ÄÇ")
            navigate_to('reception')
    else:
        st.error("„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì")
        navigate_to('reception')

    # ÁèæÂú®„Éö„Éº„Ç∏ÊÉÖÂ†±„Çí body „Å´ÂèçÊò†Ôºà„Çπ„Çø„Ç§„É´Âàá„ÇäÊõø„ÅàÁî®Ôºâ
    components.html(
        f"""
        <script>
        const body = window.parent.document.body;
        if (body) {{
            body.setAttribute('data-current-page', '{st.session_state.current_page}');
        }}
        </script>
        """,
        height=0,
        width=0
    )
    
    # „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Å∏„ÅÆ„É™„É≥„ÇØÔºàÁîªÈù¢‰∏ãÈÉ®Ôºâ
    if st.session_state.current_page == 'reception' and staff_mode:
        staff_cols = st.columns([0.5, 0.5])
        with staff_cols[1]:
            if st.button("‚öôÔ∏è „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ", width='stretch'):
                navigate_to('staff_management')

if __name__ == "__main__":
    main()
